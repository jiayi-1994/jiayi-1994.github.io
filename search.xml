<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/kubernetes/k8s-hpa-dan-xing-shen-suo.html"/>
      <url>/kubernetes/k8s-hpa-dan-xing-shen-suo.html</url>
      
        <content type="html"><![CDATA[<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>HPA在k8s中也由一个controller控制，controller会间隔循环HPA，检查每个HPA中监控的指标是否触发伸缩条件，默认的间隔时间为<strong>15s</strong>。一旦触发伸缩条件，controller会向k8s发送请求，修改伸缩对象<strong>（statefulSet、replicaController、replicaSet）</strong>子对象<strong>scale</strong>中控制<strong>pod</strong>数量的字段。<strong>k8s</strong>响应请求，修改<strong>scale</strong>结构体，然后会刷新一次伸缩对象的<strong>pod</strong>数量。伸缩对象被修改后，自然会通过<strong>list/watch</strong>机制<strong>增加或减少pod</strong>数量，达到动态伸缩的目的</p><h3 id="预先安装metrics-server"><a href="#预先安装metrics-server" class="headerlink" title="预先安装metrics-server"></a>预先安装metrics-server</h3><blockquote><p>查看hpa配置<br>2.kubect get hpa<br>查看node配置<br>kubectl top node</p></blockquote><h3 id="二、进行压力测试"><a href="#二、进行压力测试" class="headerlink" title="二、进行压力测试"></a>二、进行压力测试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl run <span class="token parameter variable">-i</span> <span class="token parameter variable">--tty</span> load-generator <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox /bin/sh<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">wget</span> <span class="token parameter variable">-q</span> -O- http://10.105.5.65<span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="三、自定义HPA"><a href="#三、自定义HPA" class="headerlink" title="三、自定义HPA"></a>三、自定义HPA</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">autoscaling.alpha.kubernetes.io/conditions</span><span class="token punctuation">:</span> '<span class="token punctuation">[</span><span class="token punctuation">{</span>"type"<span class="token punctuation">:</span><span class="token string">"AbleToScale"</span><span class="token punctuation">,</span>"status"<span class="token punctuation">:</span><span class="token string">"True"</span><span class="token punctuation">,</span>"lastTransitionTime"<span class="token punctuation">:</span><span class="token string">"2021-11-12T10:24:12Z"</span><span class="token punctuation">,</span>"reason"<span class="token punctuation">:</span><span class="token string">"ReadyForNewScale"</span><span class="token punctuation">,</span>"message"<span class="token punctuation">:</span>"recommended      size matches current size"<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>"type"<span class="token punctuation">:</span><span class="token string">"ScalingActive"</span><span class="token punctuation">,</span>"status"<span class="token punctuation">:</span><span class="token string">"True"</span><span class="token punctuation">,</span>"lastTransitionTime"<span class="token punctuation">:</span><span class="token string">"2021-11-13T04:52:54Z"</span><span class="token punctuation">,</span>"reason"<span class="token punctuation">:</span><span class="token string">"ValidMetricFound"</span><span class="token punctuation">,</span>"message"<span class="token punctuation">:</span>"the      HPA was able to successfully calculate a replica count from cpu resource utilization      (percentage of request)"<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>"type"<span class="token punctuation">:</span><span class="token string">"ScalingLimited"</span><span class="token punctuation">,</span>"status"<span class="token punctuation">:</span><span class="token string">"True"</span><span class="token punctuation">,</span>"lastTransitionTime"<span class="token punctuation">:</span><span class="token string">"2021-11-13T05:52:31Z"</span><span class="token punctuation">,</span>"reason"<span class="token punctuation">:</span><span class="token string">"TooFewReplicas"</span><span class="token punctuation">,</span>"message"<span class="token punctuation">:</span>"the      desired replica count is less than the minimum replica count"<span class="token punctuation">}</span><span class="token punctuation">]</span>'    <span class="token key atrule">autoscaling.alpha.kubernetes.io/current-metrics</span><span class="token punctuation">:</span> <span class="token string">'[{"type":"Resource","resource":{"name":"cpu","currentAverageUtilization":0,"currentAverageValue":"1m"}}]'</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-11-12T10:23:56Z"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"57579"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 5bdf76cb<span class="token punctuation">-</span>fcfd<span class="token punctuation">-</span>4761<span class="token punctuation">-</span>91a4<span class="token punctuation">-</span>24e08cf88e23<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>  <span class="token comment">## 增加其他配置限制</span><span class="token key atrule">status</span><span class="token punctuation">:</span>  <span class="token key atrule">currentCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">currentReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">desiredReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">lastScaleTime</span><span class="token punctuation">:</span> <span class="token string">"2021-11-13T05:50:00Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="四HPA-最佳实践"><a href="#四HPA-最佳实践" class="headerlink" title="四HPA 最佳实践"></a>四HPA 最佳实践</h3><ul><li>为容器配置 CPU Requests</li><li>HPA 目标设置恰当，如设置 70% 给容器和应用预留 30% 的余量</li><li>保持 Pods 和 Nodes 健康（避免 Pod 频繁重建）</li><li>保证用户请求的负载均衡</li><li>使用 kubectl top node 和 kubectl top pod 查看资源使用情况</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>压测工具Sysbench、Stress、iperf或iperf3</title>
      <link href="/ya-ce/ya-ce-gong-ju-sysbench-stress-iperf-huo-iperf3.html"/>
      <url>/ya-ce/ya-ce-gong-ju-sysbench-stress-iperf-huo-iperf3.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>sysbench是一款开源的、模块化的、跨平台的多线程性能测试工具，可用于CPU、内存、磁盘I/O、线程、数据库的性能测试。sysbench目前支持的数据库压测有PG和MySQL。（若想学习数据库压测，可以私聊麦老师哟，MySQL和PG均有相关课程）<br>工具的官网说明：<a href="https://launchpad.net/sysbench">https://launchpad.net/sysbench</a><br>sysbench支持以下几种测试模式：<br>1、CPU运算性能<br>2、磁盘IO性能<br>3、调度程序性能<br>4、内存分配及传输速度<br>5、POSIX线程性能–互斥基准测试<br>6、数据库性能(OLTP基准测试)</p></blockquote><h1 id="Sysbench"><a href="#Sysbench" class="headerlink" title="Sysbench"></a>Sysbench</h1><h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><blockquote><p>curl -s <a href="https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh">https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh</a> | sudo bash<br>sudo yum -y install sysbench<br>sysbench –version</p></blockquote><h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h2><h3 id="sysbench通用参数选项如下"><a href="#sysbench通用参数选项如下" class="headerlink" title="sysbench通用参数选项如下"></a>sysbench通用参数选项如下</h3><blockquote><p>–threads: 线程数，若设置为2，则sysbench会启动2个线程，同时分别进行素数的计算，默认值为1。<br>–time: 运行时长，单位秒。若设置为5，则sysbench会在5秒内循环进行素数计算，每完成一轮就是一个event，默认值为10。<br>–events: event上限次数，若设置为100，则表示当完成100次event后，即使时间富余也停止运行。默认值为0，则表示不限event次数。<br>–forced-shutdown=STRING：超时强制中断，默认为off。     –thread-stack-size=SIZE：线程栈大小，默认64K<br>–thread-init-timeout=N：线程初始化等待时间，默认为30秒<br>–rate=N：平均事务率，0表示不限制，默认为0。<br>–report-interval=N：测试进度报告输出的时间间隔，0表示关闭，默认为0。<br>–report-checkpoints=[LIST,…]：转储完全统计信息并在指定时间点复位所有计数器，参数是逗号分隔值的列表，表示从必须执行报告检查点的测试开始所经过的时间（以秒为单位）。 默认情况下，报告检查点处于关闭状态[off]。<br>–debug[=on|off]：打印调试信息，默认为off<br>–validate[=on|off]：尽可能执行验证检查，默认为off。<br>–help[=on|off]：打印help信息并退出，默认为off<br>–version[=on|off]：打印版本信息并退出，默认为off<br>–config-file=FILENAME：命令行选项文件<br>–luajit-cmd=STRING：执行LuaJIT控制命令</p></blockquote><h3 id="1-cpu压测"><a href="#1-cpu压测" class="headerlink" title="1. cpu压测"></a>1. cpu压测</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sysbench <span class="token parameter variable">--test</span><span class="token operator">=</span>cpu <span class="token builtin class-name">help</span>sysbench cpu --cpu-max-prime<span class="token operator">=</span><span class="token number">20000</span> <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token number">8</span> <span class="token parameter variable">--time</span><span class="token operator">=</span><span class="token number">30</span> run下面的命令表示10个线程执行800次请求，每个请求执行质数相加到80000000，下面开始压测：sysbench <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token number">10</span> <span class="token parameter variable">--events</span><span class="token operator">=</span><span class="token number">800</span>  cpu --cpu-max-prime<span class="token operator">=</span><span class="token number">80000000</span> run指标解释：Prime numbers limit: <span class="token number">20000</span>，每个线程产生的素数上限均为2000events per second: <span class="token number">650.7</span>，所有线程每秒完成了650.74次eventtotal time: <span class="token number">10</span>.0017s，共耗时10秒total number of events: <span class="token number">6510</span>，10秒内所有线程一共完成了6510次eventmin: <span class="token number">3.03</span>，完成1次event的最少耗时3.03秒avg: <span class="token number">3.07</span>，所有event的平均耗时3.07毫秒max: <span class="token number">3.27</span>，完成1次event的最多耗时3.27毫秒95th percentile: <span class="token number">3.13</span>， <span class="token number">95</span>%次event在3.13秒毫秒内完成sum: <span class="token number">19999.91</span>，每个线程耗时10秒，2个线程叠加耗时就是20秒events <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">3255.0000</span>/44.00 // 平均每个线程完成3255次event，标准差为44execution <span class="token function">time</span> <span class="token punctuation">(</span>avg/stddev<span class="token punctuation">)</span>: <span class="token number">10.0000</span>/0.00 // 每个线程平均耗时10秒，标准差为0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-内存压测"><a href="#2-内存压测" class="headerlink" title="2. 内存压测"></a>2. 内存压测</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sysbench  <span class="token parameter variable">--test</span><span class="token operator">=</span>memory <span class="token builtin class-name">help</span>--memory-block-size<span class="token operator">=</span>SIZE：测试内存块的大小，默认为1K。--memory-total-size<span class="token operator">=</span>SIZE：数据传输的总大小，默认为100G。--memory-scope<span class="token operator">=</span>STRING：内存访问的范围，包括全局和本地范围，默认为global。--memory-hugetlb<span class="token operator">=</span><span class="token punctuation">[</span>on<span class="token operator">|</span>off<span class="token punctuation">]</span>：是否从HugeTLB池分配内存的开关，默认为off。--memory-oper<span class="token operator">=</span>STRING：内存操作的类型，包括read, write, none，默认为write--memory-access-mode<span class="token operator">=</span>STRING：内存访问模式，包括seq,rnd两种模式，默认为seq。开启12个线程，内存块大小为8K，顺序读写:sysbench memory <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token number">12</span> --memory-block-size<span class="token operator">=</span>8K --memory-total-size<span class="token operator">=</span>100G --memory-access-mode<span class="token operator">=</span>seq runsysbench memory <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token number">12</span> --memory-block-size<span class="token operator">=</span>8K --memory-total-size<span class="token operator">=</span>100G --memory-access-mode<span class="token operator">=</span>rnd run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-磁盘IO性能"><a href="#3-磁盘IO性能" class="headerlink" title="3. 磁盘IO性能"></a>3. 磁盘IO性能</h3><blockquote><p>sysbench –test=fileio help<br> –file-num=N：生成测试文件的数量，默认为128。<br>–file-block-size=N：测试时所使用文件块的大小，如果想磁盘针对innodb存储引擎进行测试，可以将其设置为16384（innodb存储引擎页的大小），默认为16384。<br>–file-total-size=SIZE：创建测试文件的总大小，默认为2G大小。<br>–file-test-mode=STRING：文件测试模式，seqwr(顺序写)、seqrewr(顺序读写)、seqrd(顺序读)、rndrd(随机读)、rndwr(随机写)、rndrw(随机读写)。<br>–file-io-mode=STRING：文件操作模式，sync（同步）、async（异步）、fastmmap（快速mmap）、slowmmap（慢速mmap），默认为sync。<br>–file-async-backlog=N：对应每个线程队列的异步操作数，默认为128。<br>–file-extra-flags=STRING：打开文件时的选项，与API相关的参数。<br>–file-fsync-freq=N：执行fsync函数的频率。fsync主要是同步磁盘文件，0代表不使用fsync函数，默认值为100。<br>–file-fsync-all=[on|off]：每执行完一次写操作，就执行一次fsync。默认为off。<br>–file-fsync-end=[on|off]：测试结束时执行fsync函数，默认为on。<br>–file-fsync-mode=STRING：文件同步函数选择，和API相关的参数，由于多个操作系统对于fdatasync支持不同，因此不建议使用fdatasync，默认为fsync。<br>–file-merged-requests=N：大多情况下，合并可能的IO的请求数，默认为0。<br>–file-rw-ratio=N：测试时的读写比例，默认时为1.5，即可3：2。</p><h3 id="数据准备："><a href="#数据准备：" class="headerlink" title="数据准备："></a><strong>数据准备：</strong></h3><p>sysbench fileio –file-num=16 –file-total-size=2G prepare</p><h3 id="执行测试："><a href="#执行测试：" class="headerlink" title="执行测试："></a><strong>执行测试：</strong></h3><p>sysbench fileio –file-total-size=2G –file-test-mode=rndrd –time=180  –threads=16  –file-num=16 –file-extra-flags=direct –file-fsync-freq=0 –file-block-size=16384 run</p><h3 id="清理数据："><a href="#清理数据：" class="headerlink" title="清理数据："></a><strong>清理数据：</strong></h3><p>sysbench fileio –file-num=16 –file-total-size=2G cleanup</p></blockquote><h1 id="Stress"><a href="#Stress" class="headerlink" title="Stress"></a>Stress</h1><h2 id="1-安装-1"><a href="#1-安装-1" class="headerlink" title="1. 安装"></a>1. 安装</h2><blockquote><ol><li>[# wget <a href="https://download-ib01.fedoraproject.org/pub/epel/7/x86_64/Packages/s/stress-1.0.4-16.el7.x86_64.rpm">https://download-ib01.fedoraproject.org/pub/epel/7/x86_64/Packages/s/stress-1.0.4-16.el7.x86_64.rpm</a></li><li>[]# rpm -ivh stress-1.0.4-16.el7.x86_64.rpm</li></ol></blockquote><h2 id="2-使用-1"><a href="#2-使用-1" class="headerlink" title="2. 使用"></a>2. 使用</h2><h3 id="1-cpu"><a href="#1-cpu" class="headerlink" title="1. cpu"></a>1. cpu</h3><blockquote><p>创建8个stress进程，持续时间600秒，模拟CPU在用户态使用率达到100%的场景。<br>stress –cpu 8 –timeout 600</p></blockquote><h3 id="2-内存"><a href="#2-内存" class="headerlink" title="2. 内存"></a>2. 内存</h3><blockquote><p>创建100个io进程，持续时间600秒，模拟CPU在内核态使用率达到100%的场景。<br> stress  –io 100 –timeout 600<br>stress –vm 5 –vm-bytes 1G –vm-hang 100 –timeout 100s </p></blockquote><h3 id="3-IO"><a href="#3-IO" class="headerlink" title="3.IO"></a>3.IO</h3><blockquote><p>创建8个stress进程和100个io进程，持续时间600秒，模拟CPU在用户态和内核态总使用率达到100%的场景。<br> stress -c 8 -i 100 –verbose –timeout 600</p></blockquote><h1 id="IfTOP"><a href="#IfTOP" class="headerlink" title="IfTOP"></a>IfTOP</h1><blockquote><p>yum install flex byacc  libpcap ncurses ncurses-devel<br>yum install gcc gcc-c++ autoconf automake<br>wget <a href="ftp://fr2.rpmfind.net/linux/dag/redhat/el5/en/i386/dag/RPMS/iftop-0.17-1.el5.rf.i386.rpm">ftp://fr2.rpmfind.net/linux/dag/redhat/el5/en/i386/dag/RPMS/iftop-0.17-1.el5.rf.i386.rpm</a><br>rpm -ivh iftop-0.17-1.el5.rf.i386.rpm</p><p>wget <a href="http://www.ex-parrot.com/~pdw/iftop/download/iftop-0.17.tar.gz">http://www.ex-parrot.com/~pdw/iftop/download/iftop-0.17.tar.gz</a><br> tar -xvzf iftop-0.17.tar.gz<br>./configure &amp;&amp; make &amp;&amp; make install  </p><p>TX：发送流量<br>RX：接收流量<br>TOTAL：总流量<br>Cumm：运行iftop到目前时间的总流量<br>peak：流量峰值<br>rates：分别表示过去 2s 10s 40s 的平均流量</p></blockquote><h1 id="iperf或iperf3"><a href="#iperf或iperf3" class="headerlink" title="iperf或iperf3"></a>iperf或iperf3</h1><blockquote><h3 id="服务端运行："><a href="#服务端运行：" class="headerlink" title="服务端运行："></a>服务端运行：</h3><p>iperf -u -s</p><h4 id="u表示以udp模式运行（不加该参数，默认是以tcp模式运行），-s表示作为服务端"><a href="#u表示以udp模式运行（不加该参数，默认是以tcp模式运行），-s表示作为服务端" class="headerlink" title="-u表示以udp模式运行（不加该参数，默认是以tcp模式运行），-s表示作为服务端"></a>-u表示以udp模式运行（不加该参数，默认是以tcp模式运行），-s表示作为服务端</h4><h3 id="客户端运行："><a href="#客户端运行：" class="headerlink" title="客户端运行："></a>客户端运行：</h3><p>iperf -u -c 192.168.30.115 -b 100M -t 60 -i 2</p><h4 id="解释：在udp模式下，以100Mbps为数据发送速率，客户端到服务器192-168-30-115上传带宽测试，测试时间为60秒"><a href="#解释：在udp模式下，以100Mbps为数据发送速率，客户端到服务器192-168-30-115上传带宽测试，测试时间为60秒" class="headerlink" title="解释：在udp模式下，以100Mbps为数据发送速率，客户端到服务器192.168.30.115上传带宽测试，测试时间为60秒"></a>解释：在udp模式下，以100Mbps为数据发送速率，客户端到服务器192.168.30.115上传带宽测试，测试时间为60秒</h4><p>iperf -c 192.168.30.115 -u -i 1 -t 10 -b 2M -P 2</p><h4 id="解释：客户端同时向服务器端发起2个连接线程，每个连接线程以2Mbps为数据发送速率，测试时间为10秒"><a href="#解释：客户端同时向服务器端发起2个连接线程，每个连接线程以2Mbps为数据发送速率，测试时间为10秒" class="headerlink" title="解释：客户端同时向服务器端发起2个连接线程，每个连接线程以2Mbps为数据发送速率，测试时间为10秒"></a>解释：客户端同时向服务器端发起2个连接线程，每个连接线程以2Mbps为数据发送速率，测试时间为10秒</h4><p>iperf -u -c 192.168.30.115 -b 1000M -d -t 60 -i 1</p><h4 id="解释：以1000M为数据发送速率，进行上下行带宽测试，测试时间60秒，每秒显示一次结果"><a href="#解释：以1000M为数据发送速率，进行上下行带宽测试，测试时间60秒，每秒显示一次结果" class="headerlink" title="解释：以1000M为数据发送速率，进行上下行带宽测试，测试时间60秒，每秒显示一次结果"></a>解释：以1000M为数据发送速率，进行上下行带宽测试，测试时间60秒，每秒显示一次结果</h4></blockquote>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 压测 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【gRPC SSL】自签CA、服务端和客户端双向认证</title>
      <link href="/grpc/grpc-ssl-zi-qian-ca-fu-wu-duan-he-ke-hu-duan-shuang-xiang-ren-zheng.html"/>
      <url>/grpc/grpc-ssl-zi-qian-ca-fu-wu-duan-he-ke-hu-duan-shuang-xiang-ren-zheng.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要介绍了自签CA、服务端和客户端双向认证,主要包括自签CA、GolangGrpc服务端和客户端双向认证的相关内容,需要的朋友可以参考下</p></blockquote><h3 id="参考地址：https-blog-csdn-net-dl962454-article-details-124350199"><a href="#参考地址：https-blog-csdn-net-dl962454-article-details-124350199" class="headerlink" title="参考地址：https://blog.csdn.net/dl962454/article/details/124350199"></a>参考地址：<a href="https://blog.csdn.net/dl962454/article/details/124350199">https://blog.csdn.net/dl962454/article/details/124350199</a></h3><h2 id="一、双向认证"><a href="#一、双向认证" class="headerlink" title="一、双向认证"></a>一、双向认证</h2><h3 id="1-1-CA根证书生成"><a href="#1-1-CA根证书生成" class="headerlink" title="1.1 CA根证书生成"></a>1.1 CA根证书生成</h3><p>在openssl的bin目录下新建一个配置文件<strong>ca.conf</strong>，文件内容如下：</p><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span> <span class="token table class-name">req</span> <span class="token punctuation">]</span><span class="token key property">default_bits</span>       <span class="token punctuation">=</span> <span class="token number">2048</span><span class="token key property">distinguished_name</span> <span class="token punctuation">=</span> req_distinguished_name<span class="token punctuation">[</span> <span class="token table class-name">req_distinguished_name</span> <span class="token punctuation">]</span><span class="token key property">countryName</span>                 <span class="token punctuation">=</span> Country Name (<span class="token number">2</span> letter code)<span class="token key property">countryName_default</span>         <span class="token punctuation">=</span> CN<span class="token key property">stateOrProvinceName</span>         <span class="token punctuation">=</span> State or Province Name (full name)<span class="token key property">stateOrProvinceName_default</span> <span class="token punctuation">=</span> SiChuan<span class="token key property">localityName</span>                <span class="token punctuation">=</span> Locality Name (eg<span class="token punctuation">,</span> city)<span class="token key property">localityName_default</span>        <span class="token punctuation">=</span> Chengdu<span class="token key property">organizationName</span>            <span class="token punctuation">=</span> Organization Name (eg<span class="token punctuation">,</span> company)<span class="token key property">organizationName_default</span>    <span class="token punctuation">=</span> Step<span class="token key property">commonName</span>                  <span class="token punctuation">=</span> CommonName (e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> server FQDN or YOUR name)<span class="token key property">commonName_max</span>              <span class="token punctuation">=</span> <span class="token number">64</span><span class="token key property">commonName_default</span>          <span class="token punctuation">=</span> tonghua<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>依次执行下面的命令，执行过程中遇到的填写国家之类的直接Enter跳过，选择配置文件中默认的，从而生成**CA私钥(ca.key)<strong>、*<br>*签名请求(ca.csr)</strong> 和 <strong>签名证书（ca.crt）</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl genrsa <span class="token parameter variable">-out</span> ca.key <span class="token number">2048</span>openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-out</span> ca.csr <span class="token parameter variable">-key</span> ca.key <span class="token parameter variable">-config</span> ca.confopenssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-in</span> ca.csr signkey ca.key out ca.crt //这地方的输出可以改写成ca.pem,改写后后面命令中也要同步<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="1-2-签发服务端证书"><a href="#1-2-签发服务端证书" class="headerlink" title="1.2 签发服务端证书"></a>1.2 签发服务端证书</h3><p>接下来创建服务端配置文件server.conf，文件内容如下:</p><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span> <span class="token table class-name">req</span> <span class="token punctuation">]</span><span class="token key property">default_bits</span>       <span class="token punctuation">=</span> <span class="token number">2048</span><span class="token key property">distinguished_name</span> <span class="token punctuation">=</span> req_distinguished_name<span class="token punctuation">[</span> <span class="token table class-name">req_distinguished_name</span> <span class="token punctuation">]</span><span class="token key property">countryName</span>                 <span class="token punctuation">=</span> Country Name (<span class="token number">2</span> letter code)<span class="token key property">countryName_default</span>         <span class="token punctuation">=</span> CN<span class="token key property">stateOrProvinceName</span>         <span class="token punctuation">=</span> State or Province Name (full name)<span class="token key property">stateOrProvinceName_default</span> <span class="token punctuation">=</span> SiChuan<span class="token key property">localityName</span>                <span class="token punctuation">=</span> Locality Name (eg<span class="token punctuation">,</span> city)<span class="token key property">localityName_default</span>        <span class="token punctuation">=</span> Chengdu<span class="token key property">organizationName</span>            <span class="token punctuation">=</span> Organization Name (eg<span class="token punctuation">,</span> company)<span class="token key property">organizationName_default</span>    <span class="token punctuation">=</span> Step<span class="token key property">commonName</span>                  <span class="token punctuation">=</span> CommonName (e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> server FQDN or YOUR name)<span class="token key property">commonName_max</span>              <span class="token punctuation">=</span> <span class="token number">64</span><span class="token key property">commonName_default</span>          <span class="token punctuation">=</span> tonghua<span class="token punctuation">[</span> <span class="token table class-name">req_ext</span> <span class="token punctuation">]</span><span class="token comment"># 添加subjectAltName </span><span class="token key property">subjectAltName</span> <span class="token punctuation">=</span> @alt_names<span class="token comment"># 文件末尾添加. www.p-pp.cn代表允许的ServerName,自己随便写</span><span class="token punctuation">[</span><span class="token table class-name">alt_names</span><span class="token punctuation">]</span><span class="token key property">DNS.1</span>   <span class="token punctuation">=</span> www<span class="token punctuation">.</span>p-pp<span class="token punctuation">.</span>cn<span class="token key property">IP</span>      <span class="token punctuation">=</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样，使用上面得到的CA根证书（ca.crt）签发服务端证书，依次执行下面命令生成服务端的密钥、签名请求和签名证书：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 服务端私钥openssl genrsa <span class="token parameter variable">-out</span> server.key <span class="token number">2048</span>//服务端签名请求openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-out</span> server.csr <span class="token parameter variable">-key</span> server.key <span class="token parameter variable">-config</span> server.conf//用根证书签发服务端证书server.pemopenssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-CA</span> ca.crt <span class="token parameter variable">-CAkey</span> ca.key <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-in</span> server.csr <span class="token parameter variable">-out</span> server.pem <span class="token parameter variable">-extensions</span> req_ext <span class="token parameter variable">-extfile</span> server.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-3-签发客户端证书"><a href="#1-3-签发客户端证书" class="headerlink" title="1.3 签发客户端证书"></a>1.3 签发客户端证书</h3><p>建立配置文件client.conf：</p><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span> <span class="token table class-name">req</span> <span class="token punctuation">]</span><span class="token key property">default_bits</span>       <span class="token punctuation">=</span> <span class="token number">2048</span><span class="token key property">distinguished_name</span> <span class="token punctuation">=</span> req_distinguished_name<span class="token punctuation">[</span> <span class="token table class-name">req_distinguished_name</span> <span class="token punctuation">]</span><span class="token key property">countryName</span>                 <span class="token punctuation">=</span> Country Name (<span class="token number">2</span> letter code)<span class="token key property">countryName_default</span>         <span class="token punctuation">=</span> CN<span class="token key property">stateOrProvinceName</span>         <span class="token punctuation">=</span> State or Province Name (full name)<span class="token key property">stateOrProvinceName_default</span> <span class="token punctuation">=</span> SiChuan<span class="token key property">localityName</span>                <span class="token punctuation">=</span> Locality Name (eg<span class="token punctuation">,</span> city)<span class="token key property">localityName_default</span>        <span class="token punctuation">=</span> Chengdu<span class="token key property">organizationName</span>            <span class="token punctuation">=</span> Organization Name (eg<span class="token punctuation">,</span> company)<span class="token key property">organizationName_default</span>    <span class="token punctuation">=</span> Step<span class="token key property">commonName</span>                  <span class="token punctuation">=</span> CommonName (e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> server FQDN or YOUR name)<span class="token key property">commonName_max</span>              <span class="token punctuation">=</span> <span class="token number">64</span><span class="token key property">commonName_default</span>          <span class="token punctuation">=</span> tonghua<span class="token punctuation">[</span> <span class="token table class-name">req_ext</span> <span class="token punctuation">]</span><span class="token key property">subjectAltName</span> <span class="token punctuation">=</span> @alt_names<span class="token punctuation">[</span><span class="token table class-name">alt_names</span><span class="token punctuation">]</span><span class="token key property">DNS.1</span>   <span class="token punctuation">=</span> www<span class="token punctuation">.</span>p-pp<span class="token punctuation">.</span>cn<span class="token key property">IP</span>      <span class="token punctuation">=</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行下面命令生成客户端密钥、证书等：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl ecparam <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-name</span> secp384r1 <span class="token parameter variable">-out</span> client.keyopenssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-out</span> client.csr <span class="token parameter variable">-key</span> client.key <span class="token parameter variable">-config</span> client.confopenssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-CA</span> ca.crt <span class="token parameter variable">-CAkey</span> ca.key <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-in</span> client.csr <span class="token parameter variable">-out</span> client.pem <span class="token parameter variable">-extensions</span> req_ext <span class="token parameter variable">-extfile</span> client.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="1-4-服务端代码改写"><a href="#1-4-服务端代码改写" class="headerlink" title="1.4 服务端代码改写"></a>1.4 服务端代码改写</h3><p>服务端改写，首先拷贝ca.pem、server.key和server.pem到服务端项目中，改写代码：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"crypto/tls"</span><span class="token string">"crypto/x509"</span><span class="token string">"google.golang.org/grpc"</span><span class="token string">"google.golang.org/grpc/credentials"</span><span class="token string">"grpcpro/services"</span><span class="token string">"io/ioutil"</span><span class="token string">"log"</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token comment">// Address gRPC服务地址</span>Address <span class="token operator">=</span> <span class="token string">"127.0.0.1:8888"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// TLS认证</span><span class="token comment">//从证书相关文件中读取和解析信息，得到证书公钥、密钥对</span>cert<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">"keys/server.pem"</span><span class="token punctuation">,</span> <span class="token string">"keys/server.key"</span><span class="token punctuation">)</span>certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//初始化一个CertPool</span>ca<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"keys/ca.pem"</span><span class="token punctuation">)</span>certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span> <span class="token comment">//解析传入的证书，解析成功会将其加到池子中</span>creds <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span> <span class="token comment">//构建基于TLS的TransportCredentials选项</span>Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>cert<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">//服务端证书链，可以有多个</span>ClientAuth<span class="token punctuation">:</span>   tls<span class="token punctuation">.</span>RequireAndVerifyClientCert<span class="token punctuation">,</span> <span class="token comment">//要求必须验证客户端证书</span>ClientCAs<span class="token punctuation">:</span>    certPool<span class="token punctuation">,</span>                       <span class="token comment">//设置根证书的集合，校验方式使用 ClientAuth 中设定的模式</span><span class="token punctuation">}</span><span class="token punctuation">)</span>rpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//实例化grpc Server</span><span class="token comment">//创建带ca证书验证的服务端</span>services<span class="token punctuation">.</span><span class="token function">RegisterProdServiceServer</span><span class="token punctuation">(</span>rpcServer<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>ProdService<span class="token punctuation">)</span><span class="token punctuation">)</span>listen<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> Address<span class="token punctuation">)</span> <span class="token comment">//设置传输协议和监听地址</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Listen on "</span> <span class="token operator">+</span> Address <span class="token operator">+</span> <span class="token string">" with TLS"</span><span class="token punctuation">)</span>rpcServer<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-5-客户端代码改写"><a href="#1-5-客户端代码改写" class="headerlink" title="1.5 客户端代码改写"></a>1.5 客户端代码改写</h3><p>客户端改写：同样要拷贝ca.pem、client.key和client.pem到客户端项目中，改写代码：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"crypto/tls"</span><span class="token string">"crypto/x509"</span><span class="token string">"fmt"</span><span class="token string">"google.golang.org/grpc"</span><span class="token string">"google.golang.org/grpc/credentials"</span><span class="token string">"grpcClient/services"</span><span class="token string">"io/ioutil"</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token comment">// Address gRPC服务地址</span>Address <span class="token operator">=</span> <span class="token string">"127.0.0.1:8888"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// TLS连接</span><span class="token comment">//从证书相关文件中读取和解析信息，得到证书公钥、密钥对</span>cert<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">"keys/client.pem"</span><span class="token punctuation">,</span> <span class="token string">"keys/client.key"</span><span class="token punctuation">)</span>certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ca<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"keys/ca.pem"</span><span class="token punctuation">)</span>certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span>creds <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>cert<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//客户端证书</span>ServerName<span class="token punctuation">:</span>   <span class="token string">"www.p-pp.cn"</span><span class="token punctuation">,</span>           <span class="token comment">//注意这里的参数为配置文件中所允许的ServerName，也就是其中配置的DNS...</span>RootCAs<span class="token punctuation">:</span>      certPool<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>Address<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//连接服务端</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>prodClient <span class="token operator">:=</span> services<span class="token punctuation">.</span><span class="token function">NewProdServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>                                                <span class="token comment">//初始化客户端</span>prodRes<span class="token punctuation">,</span> err <span class="token operator">:=</span> prodClient<span class="token punctuation">.</span><span class="token function">GetProdStock</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>services<span class="token punctuation">.</span>ProdRequest<span class="token punctuation">{</span>ProdId<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//调用方法</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"grpcClient getProdStock is %d\n"</span><span class="token punctuation">,</span> prodRes<span class="token punctuation">.</span>ProdStock<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-6-双向认证成功"><a href="#1-6-双向认证成功" class="headerlink" title="1.6 双向认证成功"></a>1.6 双向认证成功</h3><p>启动两个服务之后客户端就能使用服务端的服务了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12993007/1672903044229-edd8c492-2f47-42eb-81d4-453d29b8a0ec.png#averageHue=%23262d33&amp;clientId=ue9231923-8cb9-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u53feb24a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=109&amp;originWidth=673&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=80996&amp;status=done&amp;style=none&amp;taskId=u9b6ce115-37b0-49e1-a7d2-8fd047eb139&amp;title=" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> grpc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helm 使用</title>
      <link href="/kubernetes/helm.html"/>
      <url>/kubernetes/helm.html</url>
      
        <content type="html"><![CDATA[<h1 id="Helm是什么"><a href="#Helm是什么" class="headerlink" title="Helm是什么"></a>Helm是什么</h1><p>没有使用Helm之前，在Kubernetes部署应用，我们要依次部署deployment、service等，步骤比较繁琐。况且随着很多项目微服务化，复杂的应用在容器中部署以及管理显得较为复杂。<br>helm通过打包的方式，支持发布的版本管理和控制，很大程度上简化了Kubernetes应用的部署和管理。<br>Helm本质就是让k8s的应用管理（Deployment、Service等）可配置，能动态生成。通过动态生成K8S资源清单文件（deployment.yaml、service.yaml）。然后kubectl自动调用K8S资源部署。<br>Helm是官方提供类似于YUM的包管理，是部署环境的流程封装，Helm有三个重要的概念：chart、release和Repository</p><ul><li><strong>chart</strong>是创建一个应用的信息集合，包括各种Kubernetes对象的配置模板、参数定义、依赖关系、文档说明等。可以将chart想象成apt、yum中的软件安装包。</li><li><strong>release</strong>是chart的运行实例，代表一个正在运行的应用。当chart被安装到Kubernetes集群，就生成一个release。chart能多次安装到同一个集群，每次安装都是一个release【根据chart赋值不同，完全可以部署出多个release出来】。</li><li><strong>Repository</strong>用于发布和存储 Chart 的存储库。</li></ul><p>Helm包含两个组件：Helm客户端和Tiller服务端，如下图所示：</p><p> <img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637200168556-6019a371-dafa-4b6a-a3a9-bfbf682b4088.png#clientId=u3c4056cd-8a23-4&amp;from=paste&amp;id=u4c4d8ae3&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=309&amp;originWidth=845&amp;originalType=url&amp;ratio=1&amp;size=71824&amp;status=done&amp;style=none&amp;taskId=u1f2ea02d-ed2f-4a34-b45a-dcc30028052" alt="image.png"></p><h1 id="Helm安装"><a href="#Helm安装" class="headerlink" title="Helm安装"></a>Helm安装</h1><h3 id="1-用二进制版本安装"><a href="#1-用二进制版本安装" class="headerlink" title="1.用二进制版本安装"></a>1.用二进制版本安装</h3><p>每个Helm <a href="https://github.com/helm/helm/releases">版本</a>都提供了各种操作系统的二进制版本，这些版本可以手动下载和安装。</p><ol><li>下载 <a href="https://github.com/helm/helm/releases">需要的版本</a></li><li>解压(tar -zxvf helm-v3.0.0-linux-amd64.tar.gz)</li><li>在解压目中找到helm程序，移动到需要的目录中(mv linux-amd64/helm /usr/local/bin/helm)</li></ol><p>然后就可以执行客户端程序并 <a href="https://helm.sh/zh/docs/intro/quickstart/#%e5%88%9d%e5%a7%8b%e5%8c%96">添加稳定仓库</a>: helm help.</p><h3 id="2-使用脚本安装"><a href="#2-使用脚本安装" class="headerlink" title="2.使用脚本安装"></a>2.使用脚本安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> <span class="token parameter variable">-o</span> get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3<span class="token function">chmod</span> <span class="token number">700</span> get_helm.sh./get_helm.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="3-启动服务并开启chart支持"><a href="#3-启动服务并开启chart支持" class="headerlink" title="3.启动服务并开启chart支持"></a>3.启动服务并开启chart支持</h3><blockquote><p>1.参考地址：<a href="https://blog.csdn.net/submarineas/article/details/112788040">https://blog.csdn.net/submarineas/article/details/112788040</a> 开启https、设置证书位置<br>2.生成证书：<br>openssl genrsa -out ca.key 4096</p></blockquote><blockquote><p>openssl req -x509 -new -nodes -sha512 -days 3650 <br>    -subj “/C=CN/ST=Beijing/L=Beijing/O=chinatelecom/OU=ecloudcaas/CN=192.168.56.11” <br>    -key ca.key <br>    -out ca.crt</p><p>openssl genrsa -out 192.168.56.11.key 4096</p><p>openssl req -sha512 -new <br>    -subj “/C=CN/ST=Beijing/L=Beijing/O=chinatelecom/OU=ecloudcaas/CN=192.168.56.11” <br>    -key 192.168.56.11.key <br>    -out 192.168.56.11.csr </p><p>openssl x509 -req -sha512 -days 3650 <br>    -extfile v3.ext <br>    -CA ca.crt -CAkey ca.key -CAcreateserial <br>    -in 192.168.56.11.csr <br>    -out 192.168.56.11.crt</p><p>openssl x509 -inform PEM -in 192.168.56.11.crt -out 192.168.56.11.cert</p><p>cp 192.168.56.11.cert /etc/docker/cert/192.168.56.11/<br>cp 192.168.56.11.key /etc/docker/cert/192.168.56.11/<br>cp ca.crt /etc/docker/cert/192.168.56.11/</p><p>3.启动服务加上后缀<br>./install.sh –with-notary –with-clair –with-chartmuseum<br>4.添加repo<br>helm repo add –ca-file /etc/docker/certs.d/ca.crt –username admin –password harbor myrepo <a href="https://192.168.56.11/chartrepo/demo">https://192.168.56.11/chartrepo/demo</a></p></blockquote><h1 id="Helm使用"><a href="#Helm使用" class="headerlink" title="Helm使用"></a>Helm使用</h1><h2 id="1-常用命令"><a href="#1-常用命令" class="headerlink" title="1.常用命令"></a>1.常用命令</h2><h3 id="char-管理"><a href="#char-管理" class="headerlink" title="char 管理"></a>char 管理</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> create：根据给定的name创建一个新chart<span class="token number">2</span> fetch：从仓库下载chart，并<span class="token punctuation">(</span>可选项<span class="token punctuation">)</span>将其解压缩到本地目录中<span class="token number">3</span> inspect：chart详情<span class="token number">4</span> helm package <span class="token punctuation">[</span>CHART_PATH<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>  ：打包chart目录到一个chart归档<span class="token number">5</span> lint：语法检测<span class="token number">6</span> verify：验证位于给定路径的chart已被签名且有效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="release-管理"><a href="#release-管理" class="headerlink" title="release 管理"></a>release 管理</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> get：下载一个release<span class="token number">2</span> delete：根据给定的release name，从Kubernetes中删除指定的release<span class="token number">3</span> install：安装一个chart<span class="token number">4</span> list：显示release列表  <span class="token number">5</span> upgrade：升级release  helm upgrade mytest-app01 <span class="token builtin class-name">.</span><span class="token number">6</span> rollback：回滚release到之前的一个版本  helm rollback <span class="token operator">&lt;</span>RELEASE<span class="token operator">&gt;</span> <span class="token punctuation">[</span>REVISION<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span><span class="token number">7</span> status：显示release状态信息<span class="token number">8</span> history：Fetch release历史信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="helm常见操作"><a href="#helm常见操作" class="headerlink" title="helm常见操作"></a>helm常见操作</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加仓库</span>helm repo <span class="token function">add</span> elastic https://helm.elastic.co<span class="token comment">#查看helm仓库列表</span>helm repo list<span class="token comment"># 创建chart【可供参考，一般都是自己手动创建chart】</span>helm create CHART_PATH<span class="token comment"># 根据指定chart部署一个release</span>helm <span class="token function">install</span> <span class="token parameter variable">--name</span> RELEASE_NAME CHART_PATH<span class="token comment"># 根据指定chart模拟安装一个release，并打印处debug信息</span>helm <span class="token function">install</span> --dry-run <span class="token parameter variable">--debug</span> <span class="token parameter variable">--name</span> RELEASE_NAME CHART_PATH<span class="token comment"># 列出已经部署的release</span>helm list<span class="token comment"># 列出所有的release</span>helm list <span class="token parameter variable">--all</span><span class="token comment"># 查询指定release的状态</span>helm status Release_NAME<span class="token comment"># 回滚到指定版本的release，这里指定的helm release版本</span>helm rollback Release_NAME REVISION_NUM<span class="token comment"># 查看指定release的历史信息</span>helm <span class="token function">history</span> Release_NAME<span class="token comment"># 对指定chart打包</span>helm package CHART_PATH    如：helm package my-test-app/<span class="token comment"># 对指定chart进行语法检测</span>helm lint CHART_PATH<span class="token comment"># 查看指定chart详情</span>helm inspect CHART_PATH<span class="token comment"># 从Kubernetes中删除指定release相关的资源【helm list --all 中仍然可见release记录信息】</span>helm delete RELEASE_NAME<span class="token comment"># 从Kubernetes中删除指定release相关的资源，并删除release记录</span>helm delete <span class="token parameter variable">--purge</span> RELEASE_NAME<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master my-test-app<span class="token punctuation">]</span><span class="token comment"># tree</span><span class="token builtin class-name">.</span>├── Chart.yaml├── my-app-chart-0.1.0.tgz├── templates│   ├── deployment.yaml│   └── service.yaml└── values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master my<span class="token punctuation">-</span>test<span class="token punctuation">-</span>app<span class="token punctuation">]</span><span class="token comment"># cat Chart.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">appVersion</span><span class="token punctuation">:</span> v2.2<span class="token key atrule">version</span><span class="token punctuation">:</span> 0.1.0<span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>app<span class="token punctuation">-</span>chart<span class="token key atrule">description</span><span class="token punctuation">:</span> my test app<span class="token key atrule">keywords</span><span class="token punctuation">:</span><span class="token punctuation">-</span> myapp<span class="token key atrule">maintainers</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">email</span><span class="token punctuation">:</span> zhang@test.com  <span class="token key atrule">name</span><span class="token punctuation">:</span> zhang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master my<span class="token punctuation">-</span>test<span class="token punctuation">-</span>app<span class="token punctuation">]</span><span class="token comment"># cat values.yaml </span><span class="token key atrule">deployname</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>test<span class="token punctuation">-</span>app02<span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token key atrule">images</span><span class="token punctuation">:</span>  <span class="token key atrule">repository</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/google_registry/myapp  <span class="token key atrule">tag</span><span class="token punctuation">:</span> v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master templates<span class="token punctuation">]</span><span class="token comment"># cat deployment.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.deployname <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mytestapp<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.replicaCount <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mytestapp      <span class="token key atrule">env</span><span class="token punctuation">:</span> test  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mytestapp        <span class="token key atrule">env</span><span class="token punctuation">:</span> test        <span class="token key atrule">description</span><span class="token punctuation">:</span> mytest    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.images.repository <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.images.tag <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>test<span class="token punctuation">-</span>app  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mytestapp    <span class="token key atrule">env</span><span class="token punctuation">:</span> test  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="上传chart包"><a href="#上传chart包" class="headerlink" title="上传chart包"></a>上传chart包</h3><blockquote><p>curl –request POST      –form chart=@<code>cat tgz.txt</code>      –user admin:harbor      <a href="https://192.168.56.11/api/chartrepo/demo/charts">https://192.168.56.11/api/chartrepo/demo/charts</a>  –cacert /etc/docker/certs.d/ca.crt</p></blockquote><h3 id="下载chart包，并进行部署"><a href="#下载chart包，并进行部署" class="headerlink" title="下载chart包，并进行部署"></a>下载chart包，并进行部署</h3><blockquote><p>安装<br>helm install myapp  myrepo/${CHART_NAME} –version ${CHART_VERSION}.$BUILD_NUMBER -f ../helmValue/dev.yaml</p><p>更新<br>helm upgrade myapp  myrepo/${CHART_NAME} –version ${CHART_VERSION}.$BUILD_NUMBER -f ../helmValue/dev.yaml</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress 使用</title>
      <link href="/kubernetes/ingress-wang-guan.html"/>
      <url>/kubernetes/ingress-wang-guan.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1636942313976-1d7d8c2d-1572-4d77-8c72-cf922f22632a.png#clientId=u668757c7-66ce-4&amp;from=paste&amp;height=702&amp;id=u7c561c92&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=702&amp;originWidth=835&amp;originalType=binary&amp;ratio=1&amp;size=213649&amp;status=done&amp;style=none&amp;taskId=uf62a847f-7f95-4d73-b15c-845e0c50dd1&amp;width=835" alt="image.png"></p><h2 id="官方文档地址："><a href="#官方文档地址：" class="headerlink" title="官方文档地址："></a>官方文档地址：</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-class">https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-class</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzI0MDQ4MTM5NQ==&amp;mid=2247512338&amp;idx=3&amp;sn=21ea67d53e7ae9409606df0933aeb917&amp;chksm=e918d40ede6f5d1894c00c2d7a1de2933e66ffc8b4337f06f375d5ff4059d921a13417862ea7&amp;scene=178&amp;cur_album_id=1790241575034290179#rd">https://mp.weixin.qq.com/s?__biz=MzI0MDQ4MTM5NQ==&amp;mid=2247512338&amp;idx=3&amp;sn=21ea67d53e7ae9409606df0933aeb917&amp;chksm=e918d40ede6f5d1894c00c2d7a1de2933e66ffc8b4337f06f375d5ff4059d921a13417862ea7&amp;scene=178&amp;cur_album_id=1790241575034290179#rd</a></p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>必须先具有<a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers">Ingress 控制器</a>才可以使用，参考配置 </p><h4 id="1-参考配置-1-22版本"><a href="#1-参考配置-1-22版本" class="headerlink" title="1.参考配置(1.22版本)"></a>1.参考配置(1.22版本)</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx <span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-serviceaccount.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-configmap.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">data</span><span class="token punctuation">:</span><span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/clusterrole.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> endpoints      <span class="token punctuation">-</span> nodes      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> nodes    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingressclasses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/clusterrolebinding.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-role.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> namespaces    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets      <span class="token punctuation">-</span> endpoints    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> networking.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingressclasses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>leader    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-rolebinding.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-service-webhook.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>webhook      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> webhook      <span class="token key atrule">appProtocol</span><span class="token punctuation">:</span> https  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-deployment.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> controller          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/kole_chang/controller<span class="token punctuation">:</span>v1.0.0          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>            <span class="token key atrule">preStop</span><span class="token punctuation">:</span>              <span class="token key atrule">exec</span><span class="token punctuation">:</span>                <span class="token key atrule">command</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> /wait<span class="token punctuation">-</span>shutdown          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>election<span class="token punctuation">-</span>id=ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>leader            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>controller<span class="token punctuation">-</span>class=k8s.io/ingress<span class="token punctuation">-</span>nginx            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook=<span class="token punctuation">:</span><span class="token number">8443</span>            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certificate=/usr/local/certificates/cert            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>key=/usr/local/certificates/key            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>watch<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>without<span class="token punctuation">-</span>class=true          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>              <span class="token key atrule">drop</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> ALL              <span class="token key atrule">add</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> NET_BIND_SERVICE            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LD_PRELOAD              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/lib/libmimalloc.so          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>cert              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/certificates/              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 90Mi      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>cert          <span class="token key atrule">secret</span><span class="token punctuation">:</span>            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/controller-ingressclass.yaml</span><span class="token comment"># We don't support namespaced ingressClass yet</span><span class="token comment"># So a ClusterRole and a ClusterRoleBinding is required</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> IngressClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> controller  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">controller</span><span class="token punctuation">:</span> k8s.io/ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml</span><span class="token comment"># before changing this value, check the required kubernetes version</span><span class="token comment"># https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> admissionregistration.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ValidatingWebhookConfiguration<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token key atrule">webhooks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> validate.nginx.ingress.kubernetes.io    <span class="token key atrule">matchPolicy</span><span class="token punctuation">:</span> Equivalent    <span class="token key atrule">rules</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> networking.k8s.io        <span class="token key atrule">apiVersions</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> v1        <span class="token key atrule">operations</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> CREATE          <span class="token punctuation">-</span> UPDATE        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> ingresses    <span class="token key atrule">failurePolicy</span><span class="token punctuation">:</span> Fail    <span class="token key atrule">sideEffects</span><span class="token punctuation">:</span> None    <span class="token key atrule">admissionReviewVersions</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> v1    <span class="token key atrule">clientConfig</span><span class="token punctuation">:</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission        <span class="token key atrule">path</span><span class="token punctuation">:</span> /networking/v1/ingresses<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade<span class="token punctuation">,</span>post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade<span class="token punctuation">,</span>post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> admissionregistration.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> validatingwebhookconfigurations    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade<span class="token punctuation">,</span>post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade<span class="token punctuation">,</span>post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">''</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> secrets    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> create<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade<span class="token punctuation">,</span>post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>create  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>create      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0        <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/kole_chang/kube<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certgen<span class="token punctuation">:</span>v1.0          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> create            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>host=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission<span class="token punctuation">,</span>ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>admission.$(POD_NAMESPACE).svc            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace=$(POD_NAMESPACE)            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secret<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">---</span><span class="token comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>patch  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/hook</span><span class="token punctuation">:</span> post<span class="token punctuation">-</span>install<span class="token punctuation">,</span>post<span class="token punctuation">-</span>upgrade    <span class="token key atrule">helm.sh/hook-delete-policy</span><span class="token punctuation">:</span> before<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>creation<span class="token punctuation">,</span>hook<span class="token punctuation">-</span>succeeded  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>patch      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>4.0.1        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.0.0        <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> Helm        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> admission<span class="token punctuation">-</span>webhook    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> patch          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/kole_chang/kube<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certgen<span class="token punctuation">:</span>v1.0          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> patch            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace=$(POD_NAMESPACE)            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>patch<span class="token punctuation">-</span>mutating=false            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secret<span class="token punctuation">-</span>name=ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>patch<span class="token punctuation">-</span>failure<span class="token punctuation">-</span>policy=Fail          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>admission      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">2000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-暴露ingress服务端口"><a href="#2-暴露ingress服务端口" class="headerlink" title="2.暴露ingress服务端口"></a>2.暴露ingress服务端口</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30443</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Ingress转发基本配置"><a href="#Ingress转发基本配置" class="headerlink" title="Ingress转发基本配置"></a>Ingress转发基本配置</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#1.22版本只能使用networking.k8s.io/v1,1.19到1.21可以使用v1beta1、v1</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.text.cn     <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix <span class="token comment"># 类型为前缀 三种类型：Prefix Exact ImplementationSpecific 参考Path types</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> foo            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix        <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> bar            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Ingress-HTTP-访问"><a href="#Ingress-HTTP-访问" class="headerlink" title="Ingress HTTP 访问"></a>Ingress HTTP 访问</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 访问地址：http://foo.bar.com:30080/php</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ing<span class="token punctuation">-</span>php  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> <span class="token string">"nginx"</span> <span class="token comment">##指定Ingress Controller的类型</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span>  /<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.bar.com    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /php        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[</p><p>](<a href="http://foo.bar.com:30080/php">http://foo.bar.com:30080/php</a>)</p><h2 id="升级https访问"><a href="#升级https访问" class="headerlink" title="升级https访问"></a>升级https访问</h2><h4 id="1-制作证书"><a href="#1-制作证书" class="headerlink" title="1.制作证书"></a>1.制作证书</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl genrsa <span class="token parameter variable">-out</span> xiejiayi.key <span class="token number">2048</span>openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-x509</span> <span class="token parameter variable">-key</span> xiejiayi.key <span class="token parameter variable">-out</span> xiejiayi.crt <span class="token parameter variable">-subj</span> /C<span class="token operator">=</span>CN/ST<span class="token operator">=</span>Shanghai/L<span class="token operator">=</span>Shanghai/O<span class="token operator">=</span>DevOps/CN<span class="token operator">=</span>www.xiejiayi.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="2-创建secret资源"><a href="#2-创建secret资源" class="headerlink" title="2.创建secret资源"></a>2.创建secret资源</h4><p>方法1：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">tls.crt</span><span class="token punctuation">:</span> base64 encoded cert  <span class="token key atrule">tls.key</span><span class="token punctuation">:</span> base64 encoded key<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> xiejiayi<span class="token punctuation">-</span>secret  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方法2：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create secret tls xiejiayi-secret <span class="token parameter variable">--cert</span><span class="token operator">=</span>xiejiayi.crt <span class="token parameter variable">--key</span><span class="token operator">=</span>xiejiayi.keykubectl describe secret xiejiayi-secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-调整配置启用https证书"><a href="#3-调整配置启用https证书" class="headerlink" title="3.调整配置启用https证书"></a>3.调整配置启用https证书</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 访问地址 https://foo.bar.com:30443/php 需要找到对应的nodeport对应的https映射端口访问</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ing<span class="token punctuation">-</span>php  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>     <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> <span class="token string">"nginx"</span> <span class="token comment">##指定Ingress Controller的类型</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span>  /    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span> <span class="token comment"># 增加证书</span>  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> foo.bar.com    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> xiejiayi<span class="token punctuation">-</span>secret  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.bar.com    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /php        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="采用外部访问方式"><a href="#采用外部访问方式" class="headerlink" title="采用外部访问方式"></a>采用外部访问方式</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>external<span class="token punctuation">-</span>nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>  <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> 192.168.56.12<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="规则重写"><a href="#规则重写" class="headerlink" title="规则重写"></a>规则重写</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637139090316-0480565b-19d0-4fab-b1d2-ffabed983f3e.png#clientId=u07e45915-c495-4&amp;from=paste&amp;height=338&amp;id=u2f1917ce&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=338&amp;originWidth=736&amp;originalType=binary&amp;ratio=1&amp;size=73598&amp;status=done&amp;style=none&amp;taskId=ub95a8020-5032-438e-8ed3-ec23d0fd349&amp;width=736" alt="image.png"></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>test  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//web3.escape.com<span class="token punctuation">:</span>31802/hostname.html<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web4.escape.com      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /            <span class="token key atrule">backend</span><span class="token punctuation">:</span>              <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc              <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="keepalived-VIP"><a href="#keepalived-VIP" class="headerlink" title="keepalived-VIP"></a>keepalived-VIP</h2><h3 id="rbac"><a href="#rbac" class="headerlink" title="rbac"></a>rbac</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master keepalived<span class="token punctuation">]</span><span class="token comment"># cat rbac.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> pods  <span class="token punctuation">-</span> nodes  <span class="token punctuation">-</span> endpoints  <span class="token punctuation">-</span> services  <span class="token punctuation">-</span> configmaps  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default <span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="configMap"><a href="#configMap" class="headerlink" title="configMap"></a>configMap</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master keepalived<span class="token punctuation">]</span><span class="token comment"># cat configmap.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> vip<span class="token punctuation">-</span>configmap<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">192.168.56.15</span><span class="token punctuation">:</span> default/nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="daemonSet"><a href="#daemonSet" class="headerlink" title="daemonSet"></a>daemonSet</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master keepalived<span class="token punctuation">]</span><span class="token comment"># cat vip-daemonset.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> aledbf/kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip<span class="token punctuation">:</span><span class="token number">0.35</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>keepalived<span class="token punctuation">-</span>vip          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lib/modules              <span class="token key atrule">name</span><span class="token punctuation">:</span> modules              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /dev              <span class="token key atrule">name</span><span class="token punctuation">:</span> dev          <span class="token comment"># use downward API</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace          <span class="token comment"># to use unicast</span>          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=default/vip<span class="token punctuation">-</span>configmap            <span class="token comment"># unicast uses the ip of the nodes instead of multicast</span>            <span class="token comment"># this is useful if running in cloud providers (like AWS)</span>            <span class="token comment">#- --use-unicast=true</span>      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> modules          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /lib/modules        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dev          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /dev      <span class="token comment">#nodeSelector:</span>      <span class="token comment">#  type: worker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ServiceAccount 使用</title>
      <link href="/kubernetes/serviceaccount.html"/>
      <url>/kubernetes/serviceaccount.html</url>
      
        <content type="html"><![CDATA[<h2 id="一、创建-Service-Account"><a href="#一、创建-Service-Account" class="headerlink" title="一、创建 Service Account"></a>一、创建 Service Account</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建sa账号</span>root@k8s-master pv<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount xjy</span>serviceaccount/xjy created<span class="token punctuation">[</span>root@k8s-master pv<span class="token punctuation">]</span><span class="token comment"># kubectl get sa xjy -o yaml</span>apiVersion: v1kind: ServiceAccountmetadata:  creationTimestamp: <span class="token string">"2021-11-16T02:17:24Z"</span>  name: xjy  namespace: default  resourceVersion: <span class="token string">"236090"</span>  uid: a43c6d88-1633-4cc2-ac03-059f6767a197secrets:- name: xjy-token-l4cnc<span class="token comment"># 自动创建secret</span><span class="token punctuation">[</span>root@k8s-master pv<span class="token punctuation">]</span><span class="token comment"># kubectl get secrets xjy-token-l4cnc -o yaml</span>apiVersion: v1data:  ca.crt: <span class="token punctuation">(</span>BASE64<span class="token punctuation">)</span>  token: <span class="token punctuation">(</span>BASE64<span class="token punctuation">)</span>kind: Secretmetadata:  annotations:    kubernetes.io/service-account.name: xjy    kubernetes.io/service-account.uid: a43c6d88-1633-4cc2-ac03-059f6767a197  creationTimestamp: <span class="token string">"2021-11-16T02:17:24Z"</span>  name: xjy-token-l4cnc  namespace: default  resourceVersion: <span class="token string">"236089"</span>  uid: ff3f307e-0d3c-4380-bbd5-2e7a42e197actype: kubernetes.io/service-account-token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、添加-ImagePullSecrets"><a href="#二、添加-ImagePullSecrets" class="headerlink" title="二、添加 ImagePullSecrets"></a>二、添加 ImagePullSecrets</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xiejiayi<span class="token punctuation">-</span>secret<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-11-16T02:17:24Z"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> xjy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"236738"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> a43c6d88<span class="token punctuation">-</span>1633<span class="token punctuation">-</span>4cc2<span class="token punctuation">-</span>ac03<span class="token punctuation">-</span>059f6767a197<span class="token key atrule">secrets</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xjy<span class="token punctuation">-</span>token<span class="token punctuation">-</span>l4c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>弹性伸缩 使用</title>
      <link href="/kubernetes/k8s-wen-ti-ji-lu.html"/>
      <url>/kubernetes/k8s-wen-ti-ji-lu.html</url>
      
        <content type="html"><![CDATA[<h3 id="1-calico-x2F-node-is-not-ready-BIRD-is-not-ready-BGP-not-established-with-192-168-56-12-192-168-56-10"><a href="#1-calico-x2F-node-is-not-ready-BIRD-is-not-ready-BGP-not-established-with-192-168-56-12-192-168-56-10" class="headerlink" title="1.calico/node is not ready: BIRD is not ready: BGP not established with 192.168.56.12,192.168.56.10"></a>1.calico/node is not ready: BIRD is not ready: BGP not established with 192.168.56.12,192.168.56.10</h3><blockquote><p><strong>interface=INTERFACE-REGEX</strong>配置可以指定calico使用匹配的网卡上的第一个IP地址。列出网卡和IP地址的顺序取决于系统。匹配支持goalong的正则语法。例如：</p><h1 id="Valid-IP-address-on-interface-eth0-eth1-eth2-etc"><a href="#Valid-IP-address-on-interface-eth0-eth1-eth2-etc" class="headerlink" title="Valid IP address on interface eth0, eth1, eth2 etc.*"></a>Valid IP address on interface eth0, eth1, eth2 etc.*</h1><p> IP_AUTODETECTION_METHOD=interface=eth.*<br>IP6_AUTODETECTION_METHOD=interface=eth.*<br><strong>解决方案：</strong></p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 修改calico。yaml文件</span><span class="token comment"># Specify interface</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP_AUTODETECTION_METHOD              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"interface=enp.*"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637809959372-a4b604a7-643d-4fba-8039-e594f8ec3d9d.png#clientId=u671c4818-d2a8-4&amp;from=paste&amp;height=380&amp;id=u8b8180f0&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=380&amp;originWidth=638&amp;originalType=binary&amp;ratio=1&amp;size=27126&amp;status=done&amp;style=none&amp;taskId=u1fe11ff9-9375-4a8f-b2f2-4f94cc175d6&amp;width=638" alt="image.png"></p></blockquote><h3 id="2-打开-prometheus-的监控界面，在菜单的-status-gt-Targets-中，看到-cadvisor-与-nodes-的状态都是-DOWN-而其他-api-servers-和-endpoints-是-UP-状态。DOWN-状态下的错误消息显示-server-returned-HTTP-status-403-Forbidden"><a href="#2-打开-prometheus-的监控界面，在菜单的-status-gt-Targets-中，看到-cadvisor-与-nodes-的状态都是-DOWN-而其他-api-servers-和-endpoints-是-UP-状态。DOWN-状态下的错误消息显示-server-returned-HTTP-status-403-Forbidden" class="headerlink" title="2.打开 prometheus 的监控界面，在菜单的 status -> Targets 中，看到 cadvisor 与 nodes 的状态都是 DOWN. 而其他 api-servers 和 endpoints 是 UP 状态。DOWN 状态下的错误消息显示 server returned HTTP status 403 Forbidden"></a>2.打开 prometheus 的监控界面，在菜单的 status -&gt; Targets 中，看到 cadvisor 与 nodes 的状态都是 DOWN. 而其他 api-servers 和 endpoints 是 UP 状态。DOWN 状态下的错误消息显示 server returned HTTP status 403 Forbidden</h3><blockquote><p><a href="https://www.cnblogs.com/qkhh/p/14517861.html">https://www.cnblogs.com/qkhh/p/14517861.html</a><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637822222465-20e6bc52-36ff-4a41-af07-89511439df67.png#clientId=u671c4818-d2a8-4&amp;from=paste&amp;height=411&amp;id=ue5955bee&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=411&amp;originWidth=899&amp;originalType=binary&amp;ratio=1&amp;size=30130&amp;status=done&amp;style=none&amp;taskId=u43ae94d4-266f-4037-ab4d-230a1ac17a6&amp;width=899" alt="image.png"><br>问题就出现标红的那一行。由于 cadvisor 对应的 api 是，/api/v1/nodes/${1}/proxy/metrics/cadvisor   （这里的 ${1} 会替换成具体的节点名称）。所属的 api 资源 nodes/proxy 没有被授权。如果加上授权：<br><strong>resources: [“nodes”, “nodes/proxy”, “nodes/metrics”, “services”, “endpoints”, “pods”]</strong><br>再重启 prometheus，cadvisor 和 nodes 的状态都变成 UP 了。</p></blockquote><h3 id="3-harbor上传镜像提示-http-server-gave-HTTP-response-to-HTTPS-client解决方案"><a href="#3-harbor上传镜像提示-http-server-gave-HTTP-response-to-HTTPS-client解决方案" class="headerlink" title="3.harbor上传镜像提示 http: server gave HTTP response to HTTPS client解决方案"></a>3.harbor上传镜像提示 <a href="https://www.cnblogs.com/xlizi/p/13553048.html">http: server gave HTTP response to HTTPS client解决方案</a></h3><blockquote><p><strong>在路径/etc/docker/daemon.json填写harbor配置信息</strong><br>“insecure-registries”:[“192.168.56.11:8084”],<br>重启docker<br>sudo systemctl daemon-reload<br>sudo service docker restart </p></blockquote><h3 id="4-kubelet、docker的状态正常但是提示The-connection-to-the-server-192-168-10-10-6443-was-refused-did-you-specify-the-right-host-or-port"><a href="#4-kubelet、docker的状态正常但是提示The-connection-to-the-server-192-168-10-10-6443-was-refused-did-you-specify-the-right-host-or-port" class="headerlink" title="4.kubelet、docker的状态正常但是提示The connection to the server 192.168.10.10:6443 was refused - did you specify the right host or port?"></a>4.kubelet、docker的状态正常但是提示The connection to the server 192.168.10.10:6443 was refused - did you specify the right host or port?</h3><blockquote><p><strong>参考地址：</strong><a href="https://blog.csdn.net/qq_35566365/article/details/116455177"><strong>https://blog.csdn.net/qq_35566365/article/details/116455177</strong></a><br>原因为etcd服务挂了，排查<br>docker ps 发现apiservice和etcd没有启动<br>通过docker logs 查看日志apiservice<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1638757760912-08bc9231-e5ce-4fd8-81a7-c98527536f6e.png#clientId=u3c9dd494-5d32-4&amp;from=paste&amp;height=125&amp;id=u4454e9cc&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=125&amp;originWidth=1094&amp;originalType=binary&amp;ratio=1&amp;size=19554&amp;status=done&amp;style=none&amp;taskId=ubba0b847-61f7-4b94-a503-826e9cbc7e6&amp;width=1094" alt="image.png"><br>发现apiservice无法访问 127.0.0.1:2379，<br>cat /etc/kubernetes/manifests/kube-apiserver.yaml 发现 对应的2379为etcd的端口<br>在访问查看etcd的日志<br>panic: freepages: failed to get all reachable pages (page 8463496752509895293: out of bounds: 6010)<br><strong>处理方案：会导致所有的数据丢失</strong><br>root@lax-01:/var/lib/etcd# cp xxx/etcd/** /var/lib/etcd<br>root@lax-01:/var/lib/etcd# rm -rf /var/lib/etcd/**</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>StatefulSet有状态应用 使用</title>
      <link href="/kubernetes/statefulset-you-zhuang-tai-fu-wu.html"/>
      <url>/kubernetes/statefulset-you-zhuang-tai-fu-wu.html</url>
      
        <content type="html"><![CDATA[<h4 id="参考地址：https-www-jianshu-com-p-693fe35a9156"><a href="#参考地址：https-www-jianshu-com-p-693fe35a9156" class="headerlink" title="参考地址：https://www.jianshu.com/p/693fe35a9156"></a>参考地址：<a href="https://www.jianshu.com/p/693fe35a9156">https://www.jianshu.com/p/693fe35a9156</a></h4><h2 id="一、StatefulSet组成部分"><a href="#一、StatefulSet组成部分" class="headerlink" title="一、StatefulSet组成部分"></a>一、StatefulSet组成部分</h2><ul><li><strong>Headless Service</strong>：用来定义Pod网络标识( DNS domain)。</li><li><strong>volumeClaimTemplates <strong>：存储卷申请模板，创建PVC，指定pvc名称大小，将</strong>自动创建pvc</strong>，且pvc必须由存储类供应。</li><li>**StatefulSet **：定义具体应用，名为Nginx，有三个Pod副本，并为每个Pod定义了一个域名部署statefulset。<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">为什么需要volumeClaimTemplate？对于有状态的副本集都会用到持久存储，对于分布式系统来讲，<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>red</span><span class="token punctuation">&gt;</span></span>它的最大特点是数据是不一样的<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>red</span><span class="token punctuation">&gt;</span></span>，所以各个节点不能使用同一存储卷，每个节点有自已的专用存储，但是如果在Deployment中的Pod template里定义的存储卷，是所有副本集共用一个存储卷，数据是相同的，因为是基于模板来的 ，而statefulset中每个Pod都要自已的专有存储卷，所以statefulset的存储卷就不能再用Pod模板来创建了，于是statefulSet使用volumeClaimTemplate，称为卷申请模板，它会为每个Pod生成不同的pvc，并绑定pv，从而实现各pod有专用存储。这就是为什么要用volumeClaimTemplate的原因。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h2 id="二、创建MYSQL一主多从环境"><a href="#二、创建MYSQL一主多从环境" class="headerlink" title="二、创建MYSQL一主多从环境"></a>二、创建MYSQL一主多从环境</h2><h3 id="1-定义configMap"><a href="#1-定义configMap" class="headerlink" title="1.定义configMap"></a>1.定义configMap</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">master.cnf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    # Apply this config only on the master.    [mysqld]    log-bin    log_bin_trust_function_creators=1    lower_case_table_names=1</span>  <span class="token key atrule">slave.cnf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    # Apply this config only on slaves.    [mysqld]    super-read-only    log_bin_trust_function_creators=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-定义service"><a href="#2-定义service" class="headerlink" title="2.定义service"></a>2.定义service</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>read  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-定义mysql的statefulSet文件"><a href="#3-定义mysql的statefulSet文件" class="headerlink" title="3.定义mysql的statefulSet文件"></a>3.定义mysql的statefulSet文件</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>mysql        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>5.7.30         <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> bash        <span class="token punctuation">-</span> <span class="token string">"-c"</span>        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          set -ex          # Generate mysql server-id from pod ordinal index.          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1          ordinal=${BASH_REMATCH[1]}          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf          # Add an offset to avoid reserved server-id=0 value.          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf          # Copy appropriate conf.d files from config-map to emptyDir.          if [[ $ordinal -eq 0 ]]; then            cp /mnt/config-map/master.cnf /mnt/conf.d/          else            cp /mnt/config-map/slave.cnf /mnt/conf.d/          fi</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/conf.d        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>map          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/config<span class="token punctuation">-</span>map      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> clone<span class="token punctuation">-</span>mysql        <span class="token key atrule">image</span><span class="token punctuation">:</span> anjia0532/google<span class="token punctuation">-</span>samples.xtrabackup<span class="token punctuation">:</span><span class="token number">1.0</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> bash        <span class="token punctuation">-</span> <span class="token string">"-c"</span>        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          set -ex          # Skip the clone if data already exists.          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0          # Skip the clone on master (ordinal index 0).          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1          ordinal=${BASH_REMATCH[1]}          [[ $ordinal -eq 0 ]] &amp;&amp; exit 0          # Clone data from previous peer.          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql          # Prepare the backup.          xtrabackup --prepare --target-dir=/var/lib/mysql</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> mysql        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/mysql/conf.d      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>5.7.30         <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ALLOW_EMPTY_PASSWORD          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> mysql        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/mysql/conf.d        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"mysqladmin"</span><span class="token punctuation">,</span> <span class="token string">"ping"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token comment"># Check we can execute queries over TCP (skip-networking is off).</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"-e"</span><span class="token punctuation">,</span> <span class="token string">"SELECT 1"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xtrabackup        <span class="token key atrule">image</span><span class="token punctuation">:</span> anjia0532/google<span class="token punctuation">-</span>samples.xtrabackup<span class="token punctuation">:</span><span class="token number">1.0</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xtrabackup          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3307</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> bash        <span class="token punctuation">-</span> <span class="token string">"-c"</span>        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          set -ex          cd /var/lib/mysql          # Determine binlog position of cloned data, if any.          if [[ -f xtrabackup_slave_info ]]; then            # XtraBackup already generated a partial "CHANGE MASTER TO" query            # because we're cloning from an existing slave.            mv xtrabackup_slave_info change_master_to.sql.in            # Ignore xtrabackup_binlog_info in this case (it's useless).            rm -f xtrabackup_binlog_info          elif [[ -f xtrabackup_binlog_info ]]; then            # We're cloning directly from master. Parse binlog position.            [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1            rm xtrabackup_binlog_info            echo "CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\                  MASTER_LOG_POS=${BASH_REMATCH[2]}" &gt; change_master_to.sql.in          fi          # Check if we need to complete a clone by starting replication.          if [[ -f change_master_to.sql.in ]]; then            echo "Waiting for mysqld to be ready (accepting connections)"            until mysql -h 127.0.0.1 -e "SELECT 1"; do sleep 1; done            echo "Initializing replication from clone position"            # In case of container restart, attempt this at-most-once.            mv change_master_to.sql.in change_master_to.sql.orig            mysql -h 127.0.0.1 &lt;&lt;EOF          $(&lt;change_master_to.sql.orig),            MASTER_HOST='mysql-0.mysql',            MASTER_USER='root',            MASTER_PASSWORD='',            MASTER_CONNECT_RETRY=10;          START SLAVE;          EOF          fi          # Start a server to send backups when requested by peers.          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \            "xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root"</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> mysql        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/mysql/conf.d        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>map        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>      <span class="token key atrule">storageClassName</span> <span class="token punctuation">:</span> managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage  <span class="token comment">#使用存储类创建pvc会自动创建pv，就不需要前面先创建pv</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 4Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-验证"><a href="#4-验证" class="headerlink" title="4.验证"></a>4.验证</h3><h5 id="4-1进入主节点"><a href="#4-1进入主节点" class="headerlink" title="4.1进入主节点"></a>4.1进入主节点</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-0 <span class="token function">bash</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span> create database <span class="token builtin class-name">test</span><span class="token punctuation">;</span>show databases<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="4-2进去其他节点查看是否有存在test数据库"><a href="#4-2进去其他节点查看是否有存在test数据库" class="headerlink" title="4.2进去其他节点查看是否有存在test数据库"></a>4.2进去其他节点查看是否有存在test数据库</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-1 <span class="token function">bash</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span> show databases<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="4-3查看pvc和pv挂载情况"><a href="#4-3查看pvc和pv挂载情况" class="headerlink" title="4.3查看pvc和pv挂载情况"></a>4.3查看pvc和pv挂载情况</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get pv,pvc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cronjob 使用</title>
      <link href="/kubernetes/cronjob.html"/>
      <url>/kubernetes/cronjob.html</url>
      
        <content type="html"><![CDATA[<ul><li>.spec.schedule 指定任务运行周期，格式同 Cron</li><li>.spec.jobTemplate 指定需要运行的任务，格式同 Job</li><li>.spec.startingDeadlineSeconds 指定任务开始的截止期限</li><li>.spec.concurrencyPolicy 指定任务的并发策略，支持 Allow、Forbid 和<br>Replace </li><li>三个选项</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>          <span class="token key atrule">spec</span><span class="token punctuation">:</span>                <span class="token key atrule">template</span><span class="token punctuation">:</span>                    <span class="token key atrule">spec</span><span class="token punctuation">:</span>                      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello                        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox                        <span class="token key atrule">args</span><span class="token punctuation">:</span>                        <span class="token punctuation">-</span> /bin/sh                        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c                        <span class="token punctuation">-</span> date;echo Hello from the Kubernetes cluster                      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看日志</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//查看job和查看cronjobkubect get jobkubect get cronjob<span class="token assign-left variable">pods</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">--selector</span><span class="token operator">=</span>job-name<span class="token operator">=</span>hello-27280025 <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span> <span class="token variable">)</span></span>kubectl logs <span class="token variable">$pods</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>harbor 使用</title>
      <link href="/kubernetes/harbor-an-zhuang.html"/>
      <url>/kubernetes/harbor-an-zhuang.html</url>
      
        <content type="html"><![CDATA[<h3 id="Download-harbor-helm-chart"><a href="#Download-harbor-helm-chart" class="headerlink" title="Download harbor helm chart"></a>Download harbor helm chart</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm repo <span class="token function">add</span> harbor https://helm.goharbor.iohelm fetch harbor/harbor <span class="token parameter variable">--untar</span>kubectl create ns harbor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Update-values-yaml"><a href="#Update-values-yaml" class="headerlink" title="Update values.yaml"></a>Update values.yaml</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> .harbor/values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>And change:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">expose</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> nodePort<span class="token key atrule">tls</span><span class="token punctuation">:</span>  <span class="token key atrule">commonName</span><span class="token punctuation">:</span> <span class="token string">'core.harbor.domain'</span><span class="token key atrule">persistence</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Install-helm-chart"><a href="#Install-helm-chart" class="headerlink" title="Install helm chart"></a>Install helm chart</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm <span class="token function">install</span> harbor ./harbor <span class="token parameter variable">-n</span> harbor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Wait-for-all-pod-being-ready-and-access-harbor-portal"><a href="#Wait-for-all-pod-being-ready-and-access-harbor-portal" class="headerlink" title="Wait for all pod being ready and access harbor portal"></a>Wait for all pod being ready and access harbor portal</h3><p><a href="http://192.168.34.2:30002/">http://192.168.34.2:30002</a></p><pre class="line-numbers language-none"><code class="language-none">admin/Harbor12345<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Download-repository-certs-from"><a href="#Download-repository-certs-from" class="headerlink" title="Download repository certs from"></a>Download repository certs from</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">https://192.168.34.2:30003/harbor/projects/1/repositories<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Copy-the-downloaded-ca-crt-to-vm-docker-certs-configuration-folder"><a href="#Copy-the-downloaded-ca-crt-to-vm-docker-certs-configuration-folder" class="headerlink" title="Copy the downloaded ca.crt to vm docker certs configuration folder"></a>Copy the downloaded ca.crt to vm docker certs configuration folder</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /etc/docker/certs.d/core.harbor.domaincopy the ca.crt to this foldersystemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Edit-x2F-etc-x2F-hosts-to-map-core-harbor-domain-to-harbor-svc-clusterip"><a href="#Edit-x2F-etc-x2F-hosts-to-map-core-harbor-domain-to-harbor-svc-clusterip" class="headerlink" title="Edit /etc/hosts to map core.harbor.domain to harbor svc clusterip"></a>Edit /etc/hosts to map core.harbor.domain to harbor svc clusterip</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host 配置harbor svc的集群ip</span><span class="token number">10.104</span>.231.99 core.harbor.domain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="Docker-login"><a href="#Docker-login" class="headerlink" title="Docker login"></a>Docker login</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> login <span class="token parameter variable">-u</span> admin <span class="token parameter variable">-p</span> Harbor12345 core.harbor.domain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Docker-tag-a-image-to-core-harbor-domain-and-push-it-and-you-will-see-it-in-harbor-portal"><a href="#Docker-tag-a-image-to-core-harbor-domain-and-push-it-and-you-will-see-it-in-harbor-portal" class="headerlink" title="Docker tag a image to core.harbor.domain and push it and you will see it in harbor portal"></a>Docker tag a image to core.harbor.domain and push it and you will see it in harbor portal</h3><h3 id="Check-repositories-and-blobs"><a href="#Check-repositories-and-blobs" class="headerlink" title="Check repositories and blobs"></a>Check repositories and blobs</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> harbor-registry-7d686859d7-xs5nv <span class="token parameter variable">-n</span> harbor <span class="token function">bash</span><span class="token function">ls</span> <span class="token parameter variable">-la</span> /storage/docker/registry/v2/repositories/<span class="token function">ls</span> <span class="token parameter variable">-la</span> /storage/docker/registry/v2/blobs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Database-operator"><a href="#Database-operator" class="headerlink" title="Database operator"></a>Database operator</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> harbor-database-0 <span class="token parameter variable">-n</span> harbor -- <span class="token function">bash</span>psql <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> postgres <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">5432</span><span class="token punctuation">\</span>c registry<span class="token keyword">select</span> * from harbor_user<span class="token punctuation">;</span><span class="token punctuation">\</span>dt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>容器组pod 使用</title>
      <link href="/kubernetes/pod.html"/>
      <url>/kubernetes/pod.html</url>
      
        <content type="html"><![CDATA[<h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><ul><li>spec.containers[].resources.limits.cpu ： CPU 上限， 可以短暂超过， 容器也不会被停止</li><li>spec.containers[].resources.limits.memory ： 内存上限， 不可以超过； 如果超过， 容器可能会被终止或调度到其他资源充足的机器上</li><li>spec.containers[].resources.limits.ephemeral-storage ： 临时存储（ 容器可写层、 日志以及 EmptyDir 等） 的上限， 超过后 Pod 会被驱逐</li><li>spec.containers[].resources.requests.cpu ： CPU 请求， 也是调度 CPU 资源的依据， 可以超过</li><li>spec.containers[].resources.requests.memory ： 内存请求， 也是调度内存资源的依据， 可以超过； 但如果超过， 容器可能会在 Node 内存不足时清理</li><li>spec.containers[].resources.requests.ephemeral-storage ： 临时存储（ 容器可写层、 日志以及 EmptyDir 等） 的请求， 调度容器存储的依据<br> <img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1636974596726-86910ac8-901e-4317-9a6c-10394dc50d7e.png#clientId=u80a186dc-b152-4&amp;from=paste&amp;height=474&amp;id=ubaad357f&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=474&amp;originWidth=599&amp;originalType=binary&amp;ratio=1&amp;size=43934&amp;status=done&amp;style=none&amp;taskId=u33db6349-9f44-430e-8fee-1989062e80f&amp;width=599" alt="image.png"></li></ul><h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1636974655639-8db59863-d002-4628-9c2d-307467f0f0a2.png#clientId=u80a186dc-b152-4&amp;from=paste&amp;height=361&amp;id=ua88cd119&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=361&amp;originWidth=609&amp;originalType=binary&amp;ratio=1&amp;size=97898&amp;status=done&amp;style=none&amp;taskId=u2fafd748-462a-4288-ac87-4c914bd3211&amp;width=609" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1636974843048-079474b5-02f3-4e6d-9bb4-9b20b076ef3a.png#clientId=u80a186dc-b152-4&amp;from=paste&amp;height=801&amp;id=u2cebb90b&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=801&amp;originWidth=548&amp;originalType=binary&amp;ratio=1&amp;size=84261&amp;status=done&amp;style=none&amp;taskId=uc4738430-3b7b-4688-a825-3f2931ec093&amp;width=548" alt="image.png"><br><strong>liveness probe（存活探针）</strong>：来确定何时重启容器。例如，当应用程序处于运行状态但无法做进一步操作，liveness 探针将捕获到 deadlock，重启处于该状态下的容器，使应用程序在存在 bug 的情况下依然能够继续运行下去。<br><strong>readiness probe（就绪探针）</strong>：来确定容器是否已经就绪可以接受流量。只有当 Pod 中的容器都处于就绪状态时 kubelet 才会认定该 Pod处于就绪状态。该信号的作用是控制哪些 Pod应该作为service的后端。如果 Pod 处于非就绪状态，那么它们将会被从 service 的load balancer（负载均衡）中移除。<br><strong>startupProbe(启动探测)</strong> : 指示容器中的应用是否已经启动。如果提供了启动探测(startup probe)，则禁用所有其他探测，直到它成功为止。如果启动探测失败，kubelet 将杀死容器，容器服从其重启策略进行重启。如果容器没有提供启动探测，则默认状态为成功Success。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637116192608-84a50bf2-591a-4a7a-abaf-46f37b8a3e58.png#clientId=u6ee81a2e-2a02-4&amp;from=paste&amp;id=u20daf2f6&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=602&amp;originWidth=1200&amp;originalType=url&amp;ratio=1&amp;size=364071&amp;status=done&amp;style=none&amp;taskId=ubc93a6df-6831-43b4-a921-76bcef77344" alt="image.png"></p><h2 id="存活探针"><a href="#存活探针" class="headerlink" title="存活探针"></a>存活探针</h2><h4 id="1-定义-liveness-exec请求"><a href="#1-定义-liveness-exec请求" class="headerlink" title="1.定义 liveness exec请求"></a>1.定义 liveness exec请求</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">test</span><span class="token punctuation">:</span> liveness  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">args</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /bin/sh    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c    <span class="token punctuation">-</span> touch /tmp/healthy; sleep 30; rm <span class="token punctuation">-</span>rf /tmp/healthy; sleep 600    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment"># kubelet 在容器内执行命令 cat /tmp/healthy 来进行探测。 如果命令执行成功并且返回值为 0，kubelet 就会认为这个容器是健康存活的</span>        <span class="token punctuation">-</span> cat        <span class="token punctuation">-</span> /tmp/healthy      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>~                                                                                                                                                                                        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调度失败后会进行容器重启</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># kubectl describe pod liveness-exec</span>Events:  Type     Reason     Age                 From               Message  ----     ------     ----                ----               -------  Normal   Scheduled  2m2s                default-scheduler  Successfully assigned default/liveness-exec to k8s-node1  Normal   Pulled     104s                kubelet            Successfully pulled image <span class="token string">"busybox"</span> <span class="token keyword">in</span> <span class="token number">15</span>.638033484s  Warning  Unhealthy  62s <span class="token punctuation">(</span>x3 over 72s<span class="token punctuation">)</span>   kubelet            Liveness probe failed: cat: can<span class="token string">'t open '</span>/tmp/healthy': No such <span class="token function">file</span> or directory  Normal   Killing    62s                 kubelet            Container liveness failed liveness probe, will be restarted  Normal   Pulling    32s <span class="token punctuation">(</span>x2 over 119s<span class="token punctuation">)</span>  kubelet            Pulling image <span class="token string">"busybox"</span>  Normal   Created    29s <span class="token punctuation">(</span>x2 over 104s<span class="token punctuation">)</span>  kubelet            Created container liveness  Normal   Started    29s <span class="token punctuation">(</span>x2 over 103s<span class="token punctuation">)</span>  kubelet            Started container liveness  Normal   Pulled     29s                 kubelet            Successfully pulled image <span class="token string">"busybox"</span> <span class="token keyword">in</span> <span class="token number">2</span>.736225925s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-定义-liveness-HTTP请求"><a href="#2-定义-liveness-HTTP请求" class="headerlink" title="2.定义 liveness HTTP请求"></a>2.定义 liveness HTTP请求</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">test</span><span class="token punctuation">:</span> liveness  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>http<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness    <span class="token key atrule">image</span><span class="token punctuation">:</span> fkconsultin/liveness<span class="token punctuation">-</span>testing    <span class="token key atrule">args</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /server    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">httpHeaders</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> X<span class="token punctuation">-</span>Custom<span class="token punctuation">-</span>Header          <span class="token key atrule">value</span><span class="token punctuation">:</span> Awesome      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>HTTP liveness探测失败，进行容器重启</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">Events</span><span class="token punctuation">:</span>  Type     Reason     Age                  From               Message  <span class="token punctuation">---</span><span class="token punctuation">-</span>     <span class="token punctuation">---</span><span class="token punctuation">---</span>     <span class="token punctuation">---</span><span class="token punctuation">-</span>                 <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>  Normal   Scheduled  2m47s                default<span class="token punctuation">-</span>scheduler  Successfully assigned default/liveness<span class="token punctuation">-</span>http to k8s<span class="token punctuation">-</span>node1  Normal   Pulled     117s                 kubelet            Successfully pulled image "fkconsultin/liveness<span class="token punctuation">-</span>testing" in 48.941841972s  Normal   Pulled     61s                  kubelet            Successfully pulled image "fkconsultin/liveness<span class="token punctuation">-</span>testing" in 40.836616911s  Normal   Created    36s (x3 over 117s)   kubelet            Created container liveness  Normal   Started    36s (x3 over 117s)   kubelet            Started container liveness  Normal   Pulled     36s                  kubelet            Successfully pulled image "fkconsultin/liveness<span class="token punctuation">-</span>testing" in 8.912067487s  <span class="token key atrule">Warning  Unhealthy  26s (x9 over 113s)   kubelet            Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">HTTP probe failed with statuscode</span><span class="token punctuation">:</span> <span class="token number">404</span>  Normal   Killing    26s (x3 over 107s)   kubelet            Container liveness failed liveness probe<span class="token punctuation">,</span> will be restarted  Normal   Pulling    21s (x4 over 2m46s)  kubelet            Pulling image "fkconsultin/liveness<span class="token punctuation">-</span>testing"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-定义-liveness-TCP请求"><a href="#3-定义-liveness-TCP请求" class="headerlink" title="3.定义 liveness TCP请求"></a>3.定义 liveness TCP请求</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14<span class="token punctuation">-</span>alpine    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>   <span class="token comment"># 指定tcp端口是否通</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>15 秒之后，通过看 Pod 事件来检测存活探测器：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">Events</span><span class="token punctuation">:</span>  Type     Reason     Age                From               Message  <span class="token punctuation">---</span><span class="token punctuation">-</span>     <span class="token punctuation">---</span><span class="token punctuation">---</span>     <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>  Normal   Scheduled  87s                default<span class="token punctuation">-</span>scheduler  Successfully assigned default/nginx to k8s<span class="token punctuation">-</span>node1  Normal   Killing    28s                kubelet            Container nginx failed liveness probe<span class="token punctuation">,</span> will be restarted  Normal   Pulled     27s (x2 over 86s)  kubelet            Container image "nginx<span class="token punctuation">:</span>1.14<span class="token punctuation">-</span>alpine" already present on machine  Normal   Created    27s (x2 over 86s)  kubelet            Created container nginx  Normal   Started    27s (x2 over 86s)  kubelet            Started container nginx  <span class="token key atrule">Warning  Unhealthy  8s (x9 over 78s)   kubelet            Readiness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">dial tcp 10.244.36.89:8080</span><span class="token punctuation">:</span> <span class="token key atrule">connect</span><span class="token punctuation">:</span> connection refused  <span class="token key atrule">Warning  Unhealthy  8s (x4 over 68s)   kubelet            Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">dial tcp 10.244.36.89:8080</span><span class="token punctuation">:</span> <span class="token key atrule">connect</span><span class="token punctuation">:</span> connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="就绪探针"><a href="#就绪探针" class="headerlink" title="就绪探针"></a>就绪探针</h2><p><strong>Readiness probe</strong>的配置跟<strong>liveness probe</strong>很像。唯一的不同是使用 <strong>readinessProbe</strong>而不是<strong>livenessProbe</strong>。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">exec</span><span class="token punctuation">:</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> cat    <span class="token punctuation">-</span> /tmp/healthy  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Configure-Probes"><a href="#Configure-Probes" class="headerlink" title="Configure Probes"></a>Configure Probes</h2><p>Probe 中有很多精确和详细的配置，通过它们您能准确的控制 liveness 和 readiness 检查</p><ul><li><strong>initialDelaySeconds</strong>：容器启动后第一次执行探测是需要等待多少秒。</li><li><strong>periodSeconds</strong>：执行探测的频率。默认是10秒，最小1秒。</li><li><strong>timeoutSeconds</strong>：探测超时时间。默认1秒，最小1秒。</li><li><strong>successThreshold</strong>：探测失败后，最少连续探测成功多少次才被认定为成功。默认是 1。对于 liveness 必须是 1。最小值是 1。</li><li><strong>failureThreshold</strong>：探测成功后，最少连续探测失败多少次才被认定为失败。默认是 3。最小值是 1。</li></ul><p>HTTP probe 中可以给 httpGet设置其他配置项：</p><ul><li><strong>host</strong>：连接的主机名，默认连接到 pod 的 IP。您可能想在 http header 中设置 “Host” 而不是使用 IP。</li><li><strong>scheme</strong>：连接使用的 schema，默认HTTP。</li><li><strong>path</strong>: 访问的HTTP server 的 path。</li><li><strong>httpHeaders</strong>：自定义请求的 header。HTTP运行重复的 header。</li><li><strong>port</strong>：访问的容器的端口名字或者端口号。端口号必须介于 1 和 65525 之间。</li></ul><h2 id="启动退出动作"><a href="#启动退出动作" class="headerlink" title="启动退出动作"></a>启动退出动作</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>container      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>        <span class="token key atrule">postStart</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>              <span class="token punctuation">-</span> <span class="token string">"-c"</span>              <span class="token punctuation">-</span> <span class="token string">"echo Hello from the postStart handler &gt; /usr/share/message"</span>        <span class="token key atrule">preStop</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>              <span class="token punctuation">-</span> <span class="token string">"-c"</span>              <span class="token punctuation">-</span> <span class="token string">"echo Hello from the poststop handler &gt; /usr/share/message"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>其他插件 使用</title>
      <link href="/kubernetes/qi-ta-cha-jian.html"/>
      <url>/kubernetes/qi-ta-cha-jian.html</url>
      
        <content type="html"><![CDATA[<h2 id="一、Grafana-Prometheus-node-exporter"><a href="#一、Grafana-Prometheus-node-exporter" class="headerlink" title="一、Grafana + Prometheus +node-exporter"></a>一、Grafana + Prometheus +node-exporter</h2><blockquote><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>1.参考地址：<a href="https://www.jianshu.com/p/80de3bb0ec18">https://www.jianshu.com/p/80de3bb0ec18</a><br>2.需要修改镜像prometheus、Grafana版本<br>3.调整nfs挂载pvc信息<br>4.调整rolebind中代理问题 </p><ul><li><strong>resources: [“nodes”, “nodes/proxy”, “nodes/metrics”, “services”, “endpoints”, “pods”]</strong></li></ul></blockquote><h3 id="1-node-exporter-yaml"><a href="#1-node-exporter-yaml" class="headerlink" title="1.node-exporter.yaml"></a>1.node-exporter.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter          <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>v0.16.0          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP              <span class="token key atrule">name</span><span class="token punctuation">:</span>http      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 获得Node的物理指标信息</span>      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 获得Node的物理指标信息</span><span class="token comment">#      tolerations:  # Master节点</span><span class="token comment">#        - effect: NoSchedule</span><span class="token comment">#          operator: Exists</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>service  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>http      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9100</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31672</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-Prometheus-yaml"><a href="#2-Prometheus-yaml" class="headerlink" title="2.Prometheus.yaml"></a>2.Prometheus.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter          <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>v0.16.0          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP              <span class="token key atrule">name</span><span class="token punctuation">:</span>http      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 获得Node的物理指标信息</span>      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 获得Node的物理指标信息</span><span class="token comment">#      tolerations:  # Master节点</span><span class="token comment">#        - effect: NoSchedule</span><span class="token comment">#          operator: Exists</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>service  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>http      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9100</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31672</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master prometheus<span class="token punctuation">]</span><span class="token comment"># ls</span>grafana.yaml  node<span class="token punctuation">-</span>exporter.yaml  Prometheus.yaml<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master prometheus<span class="token punctuation">]</span><span class="token comment"># cat Prometheus.yaml </span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nodes"</span><span class="token punctuation">,</span> <span class="token string">"nodes/proxy"</span><span class="token punctuation">,</span> <span class="token string">"nodes/metrics"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">,</span> <span class="token string">"endpoints"</span><span class="token punctuation">,</span> <span class="token string">"pods"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/metrics"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">prometheus.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    <span class="token comment"># my global config</span>    <span class="token key atrule">global</span><span class="token punctuation">:</span>      <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span>     15s  <span class="token comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>      <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s  <span class="token comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>      <span class="token comment"># scrape_timeout is set to the global default (10s).</span>    <span class="token comment"># Alertmanager configuration</span>    <span class="token key atrule">alerting</span><span class="token punctuation">:</span>      <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>          <span class="token comment"># - alertmanager:9093</span>    <span class="token comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>    <span class="token key atrule">rule_files</span><span class="token punctuation">:</span>      <span class="token comment"># - "first_rules.yml"</span>      <span class="token comment"># - "second_rules.yml"</span>    <span class="token comment"># A scrape configuration containing exactly one endpoint to scrape:</span>    <span class="token comment"># Here it's Prometheus itself.</span>    <span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>      <span class="token comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'prometheus'</span>        <span class="token comment"># metrics_path defaults to '/metrics'</span>        <span class="token comment"># scheme defaults to 'http'.</span>        <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span>                <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'grafana'</span>        <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token string">'grafana-service.ns-monitor:3000'</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-apiservers'</span>        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints        <span class="token comment"># Default to scraping over https. If required, just disable this or change to</span>        <span class="token comment"># `http`.</span>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https        <span class="token comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span>        <span class="token comment"># endpoints for cluster components. This is separate to discovery auth</span>        <span class="token comment"># configuration because discovery &amp; scraping are two separate concerns in</span>        <span class="token comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>        <span class="token comment"># the cluster. Otherwise, more config options have to be provided within the</span>        <span class="token comment"># &lt;kubernetes_sd_config&gt;.</span>        <span class="token key atrule">tls_config</span><span class="token punctuation">:</span>          <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt          <span class="token comment"># If your node certificates are self-signed or use a different CA to the</span>          <span class="token comment"># master CA, then disable certificate verification below. Note that</span>          <span class="token comment"># certificate verification is an integral part of a secure infrastructure</span>          <span class="token comment"># so this should only be disabled in a controlled environment. You can</span>          <span class="token comment"># disable certificate verification by uncommenting the line below.</span>          <span class="token comment">#</span>          <span class="token comment"># insecure_skip_verify: true</span>        <span class="token key atrule">bearer_token_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token        <span class="token comment"># Keep only the default/kubernetes service endpoints for the https port. This</span>        <span class="token comment"># will add targets for each API server which Kubernetes adds an endpoint to</span>        <span class="token comment"># the default/kubernetes service.</span>        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">,</span> __meta_kubernetes_service_name<span class="token punctuation">,</span> __meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep          <span class="token key atrule">regex</span><span class="token punctuation">:</span> default;kubernetes;https                <span class="token comment"># Scrape config for nodes (kubelet).</span>      <span class="token comment">#</span>      <span class="token comment"># Rather than connecting directly to the node, the scrape is proxied though the</span>      <span class="token comment"># Kubernetes apiserver.  This means it will work if Prometheus is running out of</span>      <span class="token comment"># cluster, or can't connect to nodes for some other reason (e.g. because of</span>      <span class="token comment"># firewalling).</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-nodes'</span>        <span class="token comment"># Default to scraping over https. If required, just disable this or change to</span>        <span class="token comment"># `http`.</span>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https        <span class="token comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span>        <span class="token comment"># endpoints for cluster components. This is separate to discovery auth</span>        <span class="token comment"># configuration because discovery &amp; scraping are two separate concerns in</span>        <span class="token comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>        <span class="token comment"># the cluster. Otherwise, more config options have to be provided within the</span>        <span class="token comment"># &lt;kubernetes_sd_config&gt;.</span>        <span class="token key atrule">tls_config</span><span class="token punctuation">:</span>          <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt        <span class="token key atrule">bearer_token_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> node        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_node_label_(.+)        <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> kubernetes.default.svc<span class="token punctuation">:</span><span class="token number">443</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_node_name<span class="token punctuation">]</span>          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> /api/v1/nodes/$<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>/proxy/metrics      <span class="token comment"># Scrape config for Kubelet cAdvisor.</span>      <span class="token comment">#</span>      <span class="token comment"># This is required for Kubernetes 1.7.3 and later, where cAdvisor metrics</span>      <span class="token comment"># (those whose names begin with 'container_') have been removed from the</span>      <span class="token comment"># Kubelet metrics endpoint.  This job scrapes the cAdvisor endpoint to</span>      <span class="token comment"># retrieve those metrics.</span>      <span class="token comment">#</span>      <span class="token comment"># In Kubernetes 1.7.0-1.7.2, these metrics are only exposed on the cAdvisor</span>      <span class="token comment"># HTTP endpoint; use "replacement: /api/v1/nodes/${1}:4194/proxy/metrics"</span>      <span class="token comment"># in that case (and ensure cAdvisor's HTTP server hasn't been disabled with</span>      <span class="token comment"># the --cadvisor-port=0 Kubelet flag).</span>      <span class="token comment">#</span>      <span class="token comment"># This job is not necessary and should be removed in Kubernetes 1.6 and</span>      <span class="token comment"># earlier versions, or it will cause the metrics to be scraped twice.</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-cadvisor'</span>        <span class="token comment"># Default to scraping over https. If required, just disable this or change to</span>        <span class="token comment"># `http`.</span>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https        <span class="token comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span>        <span class="token comment"># endpoints for cluster components. This is separate to discovery auth</span>        <span class="token comment"># configuration because discovery &amp; scraping are two separate concerns in</span>        <span class="token comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span>        <span class="token comment"># the cluster. Otherwise, more config options have to be provided within the</span>        <span class="token comment"># &lt;kubernetes_sd_config&gt;.</span>        <span class="token key atrule">tls_config</span><span class="token punctuation">:</span>          <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt        <span class="token key atrule">bearer_token_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> node        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_node_label_(.+)        <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> kubernetes.default.svc<span class="token punctuation">:</span><span class="token number">443</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_node_name<span class="token punctuation">]</span>          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> /api/v1/nodes/$<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>/proxy/metrics/cadvisor      <span class="token comment"># Scrape config for service endpoints.</span>      <span class="token comment">#</span>      <span class="token comment"># The relabeling allows the actual service scrape endpoint to be configured</span>      <span class="token comment"># via the following annotations:</span>      <span class="token comment">#</span>      <span class="token comment"># * `prometheus.io/scrape`: Only scrape services that have a value of `true`</span>      <span class="token comment"># * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need</span>      <span class="token comment"># to set this to `https` &amp; most likely set the `tls_config` of the scrape config.</span>      <span class="token comment"># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span>      <span class="token comment"># * `prometheus.io/port`: If the metrics are exposed on a different port to the</span>      <span class="token comment"># service then set this appropriately.</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-service-endpoints'</span>        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scrape<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep          <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scheme<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __scheme__          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (https<span class="token punctuation">?</span>)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_path<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_service_annotation_prometheus_io_port<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_service_label_(.+)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_name      <span class="token comment"># Example scrape config for probing services via the Blackbox Exporter.</span>      <span class="token comment">#</span>      <span class="token comment"># The relabeling allows the actual service scrape endpoint to be configured</span>      <span class="token comment"># via the following annotations:</span>      <span class="token comment">#</span>      <span class="token comment"># * `prometheus.io/probe`: Only probe services that have a value of `true`</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-services'</span>        <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /probe        <span class="token key atrule">params</span><span class="token punctuation">:</span>          <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span>        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> service        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_probe<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep          <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span>          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __param_target        <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> blackbox<span class="token punctuation">-</span>exporter.example.com<span class="token punctuation">:</span><span class="token number">9115</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span>          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> instance        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_service_label_(.+)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_name      <span class="token comment"># Example scrape config for probing ingresses via the Blackbox Exporter.</span>      <span class="token comment">#</span>      <span class="token comment"># The relabeling allows the actual ingress scrape endpoint to be configured</span>      <span class="token comment"># via the following annotations:</span>      <span class="token comment">#</span>      <span class="token comment"># * `prometheus.io/probe`: Only probe services that have a value of `true`</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-ingresses'</span>        <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /probe        <span class="token key atrule">params</span><span class="token punctuation">:</span>          <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span>        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> ingress        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_ingress_annotation_prometheus_io_probe<span class="token punctuation">]</span>            <span class="token key atrule">action</span><span class="token punctuation">:</span> keep            <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_ingress_scheme<span class="token punctuation">,</span>__address__<span class="token punctuation">,</span>__meta_kubernetes_ingress_path<span class="token punctuation">]</span>            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+);(.+);(.+)            <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">:</span>//$<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span>$<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>            <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __param_target          <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__            <span class="token key atrule">replacement</span><span class="token punctuation">:</span> blackbox<span class="token punctuation">-</span>exporter.example.com<span class="token punctuation">:</span><span class="token number">9115</span>          <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span>            <span class="token key atrule">target_label</span><span class="token punctuation">:</span> instance          <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap            <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_ingress_label_(.+)          <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>            <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace          <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_ingress_name<span class="token punctuation">]</span>            <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_name      <span class="token comment"># Example scrape config for pods</span>      <span class="token comment">#</span>      <span class="token comment"># The relabeling allows the actual pod scrape endpoint to be configured via the</span>      <span class="token comment"># following annotations:</span>      <span class="token comment">#</span>      <span class="token comment"># * `prometheus.io/scrape`: Only scrape pods that have a value of `true`</span>      <span class="token comment"># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span>      <span class="token comment"># * `prometheus.io/port`: Scrape the pod on the indicated port instead of the</span>      <span class="token comment"># pod's declared ports (default is a port-free target if none are declared).</span>      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-pods'</span>        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> pod        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_annotation_prometheus_io_scrape<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep          <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_annotation_prometheus_io_path<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_pod_annotation_prometheus_io_port<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_pod_label_(.+)        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span>          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_pod_name<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>rules  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">cpu-usage.rule</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    groups:      - name: NodeCPUUsage        rules:          - alert: NodeCPUUsage            expr: (100 - (avg by (instance) (irate(node_cpu{name="node-exporter",mode="idle"}[5m])) * 100)) &gt; 75            for: 2m            labels:              severity: "page"            annotations:              summary: "{{$labels.instance}}: High CPU usage detected"              description: "{{$labels.instance}}: CPU usage is above 75% (current value is: {{ $value }})"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"prometheus-data-pv"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pv    <span class="token key atrule">release</span><span class="token punctuation">:</span> stable<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfsdata/prometheus/data    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.56.11<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pv      <span class="token key atrule">release</span><span class="token punctuation">:</span> stable<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus          <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>v2.30.0          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /prometheus              <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>volume            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/prometheus/prometheus.yml              <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>conf<span class="token punctuation">-</span>volume              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> prometheus.yml            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/prometheus/rules              <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>rules<span class="token punctuation">-</span>volume          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>volume          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>conf<span class="token punctuation">-</span>volume          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>conf        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>rules<span class="token punctuation">-</span>volume          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>rules      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">'true'</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>service  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-grafana-yaml"><a href="#3-grafana-yaml" class="headerlink" title="3.grafana.yaml"></a>3.grafana.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> grafana    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana          <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>8.2.0          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_AUTH_BASIC_ENABLED              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_AUTH_ANONYMOUS_ENABLED              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /login              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/grafana              <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>data<span class="token punctuation">-</span>volume          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>data<span class="token punctuation">-</span>volume          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>service  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>monitor<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s相关基础命令 使用</title>
      <link href="/kubernetes/k8s-ji-chu-ming-ling-he-qi-ta-qing-kuang-ji-lu.html"/>
      <url>/kubernetes/k8s-ji-chu-ming-ling-he-qi-ta-qing-kuang-ji-lu.html</url>
      
        <content type="html"><![CDATA[<h1 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h1><h2 id="一-环境搭建"><a href="#一-环境搭建" class="headerlink" title="一.环境搭建"></a>一.环境搭建</h2><h4 id="参考地址-："><a href="#参考地址-：" class="headerlink" title="参考地址 ："></a>参考地址 ：</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>tz90<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">15466646.</span>html#最新、最全、最详细的 <span class="token constant">K8S</span> 学习笔记总结（<span class="token number">2021</span>最新版）https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">2</span>cbdf5b65bb7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="二-命令"><a href="#二-命令" class="headerlink" title="二.命令"></a>二.命令</h2><h4 id="命令自动补全："><a href="#命令自动补全：" class="headerlink" title="命令自动补全："></a>命令自动补全：</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y bash-completion</span><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># source /usr/share/bash-completion/bash_completion</span><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># source &lt;(kubectl completion bash)</span><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-查看类常用命令"><a href="#1-查看类常用命令" class="headerlink" title="1.查看类常用命令"></a>1.查看类常用命令</h4><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#生成加入token</span><span class="token key attr-name">kubeadm</span> <span class="token value attr-value">join 192.168.56.12:6443 --token qj0nng.wmfof5ego8i5bx5f --discovery-token-ca-cert-hash sha256:ed86c67741198cf7da9a8775db01672d00dfa6833d3e9059adb3ebdff09aebc8 </span><span class="token comment"># 查看node，pod，svc，cs，event，cm,sa ,deploy jobs ,ing ingresses</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">get pod </span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">get nod</span><span class="token comment">#查看命名空间</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">-n kube-system</span><span class="token comment">#查看node、pod启动情况</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">describe pod nginx-6799fc88d8-lwqb7</span><span class="token comment">#查看日志</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">logs --tail=300 -f nginx-6799fc88d8-lwqb7</span><span class="token comment">#调试容器</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">debug -n  zstack edge-vm-controller-6bbfc84f4f-hj66v   --image centos --target edge-vm-controller  -it</span><span class="token comment">#创建一份副本进行测试</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">debug cdebug-64cd86798b-sjxrl -it --image=centos --share-processes --copy-to=cdebug-debug -- sh</span><span class="token comment">#调试主机</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">debug node/10.69.202.146 -it --image=centos -- shchroot /host</span><span class="token comment">#进入容器</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">exec nginx-6799fc88d8-lwqb7 -it -- /bin/sh</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">exec mypod -c ruby-container -it -- bash</span><span class="token comment"># 切换命名空间</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">config set-context $(kubectl config current-context) --namespace=kube-ops</span><span class="token comment"># 查看pod的详细信息，以yaml格式或json格式显示</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">get pods -o yaml</span><span class="token comment"># 查看pod的标签信息</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">get pod -A --show-labels </span><span class="token comment"># 根据Selector（label query）来查询pod</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">get pod -A --selector="k8s-app=kube-dns"</span><span class="token comment">#查看运行pod的环境变量</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">exec podName env</span><span class="token comment"># 查看系统资源利用率</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">exec nginx-app-4028413181-cnt1i ps aux</span><span class="token comment">#权限判断</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">auth can-i create pods --all-namespaces</span><span class="token comment">#查看job</span><span class="token key attr-name">kubect</span> <span class="token value attr-value">get job  \ kubect get cronjob</span><span class="token comment">#查看所有存储信息记录</span><span class="token key attr-name">df</span> <span class="token value attr-value">-Th</span><span class="token comment">#查看组件日志</span><span class="token key attr-name">journalctl</span> <span class="token value attr-value">-l -u kube-apiserver</span><span class="token key attr-name">journalctl</span> <span class="token value attr-value">-l -u kube-controller-manager</span><span class="token key attr-name">journalctl</span> <span class="token value attr-value">-l -u kube-scheduler</span><span class="token key attr-name">journalctl</span> <span class="token value attr-value">-l -u kubelet</span><span class="token key attr-name">journalctl</span> <span class="token value attr-value">-l -u kube-proxy</span><span class="token comment">#格式化输出</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">custom-columns=&lt;spec&gt;   #使用逗号分隔的自定义列列表打印表格</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">custom-columns-file=&lt;filename&gt; #使用文件中的自定义列模板打印表格</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">json    #输出JSON 格式的API对象</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">jsonpath=&lt; template&gt;       #打印jsonpath表达式中定义的字段</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">jsonpath-file=&lt;filename&gt;   #打印由文件中的jsonpath表达式定义的字段</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">name  #仅打印资源名称 </span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">wide  #以纯文本格式输出任何附加信息，对于Pod ，包含节点名称</span><span class="token key attr-name">-o</span><span class="token punctuation">=</span><span class="token value attr-value">yaml  #输出 YAML 格式的 API 对象 </span><span class="token comment">#查看卡住服务</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">api-resources --verbs=list --namespaced -o name   | xargs -n 1 kubectl get --show-kind --ignore-not-found -n kubesphere-logging-system</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-操作类指令"><a href="#2-操作类指令" class="headerlink" title="2.操作类指令"></a>2.操作类指令</h4><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#创建资源</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">create -f xxx.yaml</span><span class="token comment"># 应用资源</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">apply -f xxx.yaml</span><span class="token comment"># 应用资源，该目录下的所有 .yaml, .yml, 或 .json 文件都会被使用</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">apply -f &lt;directory&gt;</span><span class="token comment"># 创建test名称空间</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">create namespace test</span><span class="token comment"># 编辑资源</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">edit pod podName</span><span class="token comment"># 删除指定的pod</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">delete pod podName</span><span class="token comment">#文件复制</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">cp /tmp/foo_dir &lt;some-pod&gt;:/tmp/bar_dir</span><span class="token comment">#维护模式（标志node不可调度，但不影响现有pod）</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">cordon k8s-node1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-高级指令"><a href="#3-高级指令" class="headerlink" title="3. 高级指令"></a>3. 高级指令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#######################回滚操作#############</span><span class="token comment"># 查询历史版本</span>$ kubectl rollout <span class="token function">history</span> daemonset <span class="token operator">&lt;</span>daemonset-name<span class="token operator">&gt;</span>kubectl rollout <span class="token function">history</span> deploy php-apache<span class="token comment"># 查询某个历史版本的详细信息</span>$ kubectl rollout <span class="token function">history</span> daemonset <span class="token operator">&lt;</span>daemonset-name<span class="token operator">&gt;</span> <span class="token parameter variable">--revision</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment"># 回滚</span>$ kubectl rollout undo daemonset <span class="token operator">&lt;</span>daemonset-name<span class="token operator">&gt;</span> --to-revision<span class="token operator">=</span><span class="token operator">&lt;</span>revision<span class="token operator">&gt;</span><span class="token comment"># 查询回滚状态</span>$ kubectl rollout status  deploy <span class="token operator">&lt;</span>daemonset-name<span class="token operator">&gt;</span><span class="token comment">#######################扩容操作#################</span><span class="token comment">#手动扩容 </span>kubectl scale deployment php-apache <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">2</span><span class="token comment">#自动扩容（需要配合HPA metric使用）</span>kubectl autoscale deployment php-apache --cpu-percent<span class="token operator">=</span><span class="token number">50</span> <span class="token parameter variable">--min</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token number">10</span><span class="token comment">#镜像更新</span>kubectl <span class="token builtin class-name">set</span> image deployment/nginx-deployment my-nginx<span class="token operator">=</span>nginx:1.9.1<span class="token comment"># 添加标签</span>kubectl label pods my-pod new-label<span class="token operator">=</span>awesome<span class="token comment"># 添加注解</span>kubectl annotate pods my-pod icon-url<span class="token operator">=</span>http://goo.gl/XXBTWq<span class="token comment"># 部分更新节点</span>kubectl patch <span class="token function">node</span> k8s-node-1 <span class="token parameter variable">-p</span> <span class="token string">'{"spec":{"unschedulable":true}}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h4><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">## dashboard生成token</span><span class="token comment"># 创建用户</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">create serviceaccount dashboard-admin -n kube-system</span><span class="token comment"># 用户授权</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><span class="token comment"># 获取用户Token</span><span class="token key attr-name">kubectl</span> <span class="token value attr-value">describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本信息</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 资源类别</span><span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token comment"># 资源元数据</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment <span class="token comment"># 元数据对应的名称</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token key atrule">app-test   namespace</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>test   <span class="token key atrule">lables</span><span class="token punctuation">:</span> <span class="token comment"># 对资源打上便签供后续使用</span>    <span class="token key atrule">apps</span><span class="token punctuation">:</span> nginx   <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token comment"># 主要目的是方便用户阅读查找</span><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 定义期望状态</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>       <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>集群调度 使用</title>
      <link href="/kubernetes/ji-qun-diao-du.html"/>
      <url>/kubernetes/ji-qun-diao-du.html</url>
      
        <content type="html"><![CDATA[<h2 id="调度过程"><a href="#调度过程" class="headerlink" title="调度过程"></a>调度过程</h2><p>调度分为几个部分：首先是<strong>过滤掉不满足条件</strong>的节点，这个过程称为 <strong>predicate</strong>；然后对通过的节点按照优先级排序，这个是 <strong>priority</strong>；最后从中选择<strong>优先级最高的节点</strong>。如果中间任何一步骤有错误，就直接返回错误。Predicate 有一系列的算法可以使用：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637141679431-1ca2587a-f7f0-48bd-96a2-60f968923735.png#clientId=u8142e09e-abda-4&amp;from=paste&amp;height=422&amp;id=u9944d429&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=422&amp;originWidth=893&amp;originalType=binary&amp;ratio=1&amp;size=199391&amp;status=done&amp;style=none&amp;taskId=u33d14cbf-ad58-44b4-a979-c42e5f88884&amp;width=893" alt="image.png"><br>如果在 <strong>predicate <strong>过程中没有合适的节点，</strong>pod 会一直在 pending 状态</strong>，不断重试调度，直到有节点满足条件。经过这个步骤，如果有多个节点满足条件，就继续 <strong>priorities <strong>过程：按照</strong>优先级大小对节点排序</strong>。优先级由一系列键值对组成，键是该优先级项的名称，值是它的权重（该项的重要性）。这些优先级选项包括：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637141723086-4ccda8d2-e19c-4b56-bcc8-16a560ce308a.png#clientId=u8142e09e-abda-4&amp;from=paste&amp;height=247&amp;id=u53e449b8&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=247&amp;originWidth=930&amp;originalType=binary&amp;ratio=1&amp;size=155294&amp;status=done&amp;style=none&amp;taskId=ue8e33cdb-6442-4b08-8f12-2bc539f8f5b&amp;width=930" alt="image.png"></p><h2 id="亲和性"><a href="#亲和性" class="headerlink" title="亲和性"></a>亲和性</h2><h3 id="节点亲和性（pod-spec-nodeAffinity）"><a href="#节点亲和性（pod-spec-nodeAffinity）" class="headerlink" title="节点亲和性（pod.spec.nodeAffinity）"></a>节点亲和性（pod.spec.nodeAffinity）</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637141900615-158977f3-a3c6-4fa9-a7e0-9e95388277e4.png#clientId=u8142e09e-abda-4&amp;from=paste&amp;height=436&amp;id=u3b26b576&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=436&amp;originWidth=833&amp;originalType=binary&amp;ratio=1&amp;size=138128&amp;status=done&amp;style=none&amp;taskId=ue5808968-0aa2-4536-98d5-eea3595a62f&amp;width=833" alt="image.png"></p><h4 id="硬策略-requiredDuringSchedulingIgnoredDuringExecution"><a href="#硬策略-requiredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="硬策略 - requiredDuringSchedulingIgnoredDuringExecution"></a>硬策略 - requiredDuringSchedulingIgnoredDuringExecution</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> affinity  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>affinity<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname                <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn                <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> k8s<span class="token punctuation">-</span>node<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="软策略-preferredDuringSchedulingIgnoredDuringExecution"><a href="#软策略-preferredDuringSchedulingIgnoredDuringExecution" class="headerlink" title="软策略 - preferredDuringSchedulingIgnoredDuringExecution"></a>软策略 - preferredDuringSchedulingIgnoredDuringExecution</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> affinity  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>affinity<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">preference</span><span class="token punctuation">:</span>            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> source                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Pod-亲和性-pod-spec-affinity-podAffinity-x2F-podAntiAffinity"><a href="#Pod-亲和性-pod-spec-affinity-podAffinity-x2F-podAntiAffinity" class="headerlink" title="Pod 亲和性(pod.spec.affinity.podAffinity/podAntiAffinity)"></a>Pod 亲和性(pod.spec.affinity.podAffinity/podAntiAffinity)</h3><ul><li><strong>硬策略 - requiredDuringSchedulingIgnoredDuringExecution</strong></li><li><strong>软策略 - preferredDuringSchedulingIgnoredDuringExecution</strong><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#硬策略</span>            <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                    <span class="token key atrule">values</span><span class="token punctuation">:</span>                      <span class="token punctuation">-</span> pod<span class="token punctuation">-</span><span class="token number">1</span>              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#软策略</span>            <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>              <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>                <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                  <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                      <span class="token key atrule">values</span><span class="token punctuation">:</span>                        <span class="token punctuation">-</span> pod<span class="token punctuation">-</span><span class="token number">2</span>                <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://cdn.nlark.com/yuque/0/2021/png/12993007/1637142207783-5bc4a765-8476-406b-a924-d2866abd6b32.png#clientId=u8142e09e-abda-4&amp;from=paste&amp;height=428&amp;id=uc3c7ca0c&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=428&amp;originWidth=932&amp;originalType=binary&amp;ratio=1&amp;size=93525&amp;status=done&amp;style=none&amp;taskId=u50685864-94ae-405b-a935-19016a0d1d2&amp;width=932" alt="image.png"></li></ul><h4 id="注：拓扑域"><a href="#注：拓扑域" class="headerlink" title="注：拓扑域"></a>注：拓扑域</h4><p>第一种，在使用云存储服务的时候，经常会遇到 <strong>region</strong>，也就是地区的概念，在 K8s 中常通过 label failure-domain.beta.kubernetes.io/region 来标识。这个是为了标识单个 K8s 集群管理的跨 region 的 nodes 到底属于哪个地区；<br>第二种，比较常用的是<strong>可用区</strong>，也就是** available zone**，在 K8s 中常通过 label failure-domain.beta.kubernetes.io/zone 来标识。这个是为了标识单个 K8s 集群管理的跨 zone 的 nodes 到底属于哪个可用区；<br>第三种，是 <strong>hostname</strong>，就是单机维度，是拓扑域为 **node **范围，在 K8s 中常通过 label kubernetes.io/hostname 来标识，<br>[</p><p>](<a href="https://blog.csdn.net/weixin_30336949/article/details/112485203">https://blog.csdn.net/weixin_30336949/article/details/112485203</a>)</p><h2 id="污点和容忍"><a href="#污点和容忍" class="headerlink" title="污点和容忍"></a>污点和容忍</h2><p>节点亲和性，是 pod 的一种属性（偏好或硬性要求），它使 pod 被吸引到一类特定的节点。Taint 则相反，它使节点能够<strong>排斥</strong>一类特定的 pod。</p><p>**Taint **和 **toleration **相互配合，可以用来避免 <strong>pod 被分配到不合适的节点上</strong>。每个节点上都可以应用一个或多个 taint，这表示对于那些不能容忍这些 taint 的 pod，是不会被该节点接受的。如果将 toleration 应用于 pod 上，则表示这些 pod 可以（但不要求）被调度到具有匹配 taint 的节点上。</p><h3 id="污点"><a href="#污点" class="headerlink" title="污点"></a>污点</h3><ul><li><strong>NoSchedule</strong>：表示 k8s 将不会将 Pod 调度到具有该污点的 Node 上</li><li><strong>PreferNoSchedule</strong>：表示 k8s 将尽量避免将 Pod 调度到具有该污点的 Node 上</li><li><strong>NoExecute</strong>：将不会将 Pod 调度到具有该污点的 Node 上，同时会将 Node 上已经存在的 Pod 驱逐出去</li></ul><h4 id="1-查看污点"><a href="#1-查看污点" class="headerlink" title="1.查看污点"></a>1.查看污点</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl describe <span class="token function">node</span> k8s-masterTaints:         node-role.kubernetes.io/master:NoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="2-污点的设置、查看和去除"><a href="#2-污点的设置、查看和去除" class="headerlink" title="2.污点的设置、查看和去除"></a>2.污点的设置、查看和去除</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 设置污点</span>$ kubectl taint nodes k8s<span class="token punctuation">-</span>node1 key1=value1<span class="token punctuation">:</span>NoSchedule$ kubectl taint nodes k8s<span class="token punctuation">-</span>node1 type=master<span class="token punctuation">:</span>NoExecute<span class="token comment"># 节点说明中查找Taints字段</span>$ kubectl describe pod pod<span class="token punctuation">-</span>name<span class="token comment"># 去除污点</span>$ kubectl taint nodes k8s<span class="token punctuation">-</span>node1 key1<span class="token punctuation">:</span>NoSchedule<span class="token punctuation">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="容忍"><a href="#容忍" class="headerlink" title="容忍"></a>容忍</h4><p>设置了污点的 Node 将根据 taint 的 effect：<strong>NoSchedule</strong>、<strong>PreferNoSchedule</strong>、<strong>NoExecute <strong>和 Pod 之间产生</strong>互斥</strong>的关系，Pod 将在一定程度上不会被调度到 Node 上。但我们可以在 Pod 上设置容忍，意思是设置了<strong>容忍的 Pod 将可以容忍污点的存在</strong>，可以被调度到存在污点的 Node 上。</p><ul><li>pod.spec.tolerations<ul><li>其中 operator 的值为 Exists 将会忽略 value 值</li><li>其中 key, value, effect 要与 Node 上设置的 taint 保持一致</li><li>其中 tolerationSeconds 用于描述当 Pod 需要被驱逐时可以在 Pod 上继续保留运行的时间<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">3</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"type"</span>      <span class="token key atrule">operator</span><span class="token punctuation">:</span> "Equal" //操作符      <span class="token key atrule">value</span><span class="token punctuation">:</span> "master"  //key，value      <span class="token key atrule">effect</span><span class="token punctuation">:</span> "NoSchedule"   //污点策略      <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> 3600 //保留运行时间秒    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"type"</span>      <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span>      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"master"</span>      <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span>    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"type"</span>      <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>      <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoSchedule"</span>      <span class="token punctuation">---</span><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>  当不指定 key 值时，表示容忍所有的污点 key  <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>  <span class="token punctuation">---</span><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>  <span class="token comment">#当不指定 effect 值时，表示容忍所有的污点作用</span>  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"key"</span>    <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="指定调度节点"><a href="#指定调度节点" class="headerlink" title="指定调度节点"></a>指定调度节点</h2><p>将 Pod 直接调度到指定的 Node 节点上，会跳过 Scheduler 的调度策略，该匹配规则是<strong>强制匹配。</strong></p><h4 id="1-通过nodeName"><a href="#1-通过nodeName" class="headerlink" title="1.通过nodeName"></a>1.通过nodeName</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">7</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node1  <span class="token comment">## 通过nodename</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb          <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-通过标签"><a href="#2-通过标签" class="headerlink" title="2.通过标签"></a>2.通过标签</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb    <span class="token key atrule">spec</span><span class="token punctuation">:</span>    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>  <span class="token comment">#通过标签选择</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> BackendNode    <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb        <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1        ports<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>存储 使用</title>
      <link href="/kubernetes/cun-chu.html"/>
      <url>/kubernetes/cun-chu.html</url>
      
        <content type="html"><![CDATA[<h4 id="参考地址：https-www-yuque-com-u12604243-mc2aau-qgh2pg-IHoc8"><a href="#参考地址：https-www-yuque-com-u12604243-mc2aau-qgh2pg-IHoc8" class="headerlink" title="参考地址：https://www.yuque.com/u12604243/mc2aau/qgh2pg#IHoc8"></a>参考地址：<a href="#IHoc8">https://www.yuque.com/u12604243/mc2aau/qgh2pg#IHoc8</a></h4><h1 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h1><h2 id="创建Map"><a href="#创建Map" class="headerlink" title="创建Map"></a>创建Map</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#使用目录创建</span>kubectl create configmap ganme-config --from-file<span class="token operator">=</span><span class="token punctuation">..</span>/mapdir<span class="token comment">#使用文件创建</span>kubectl create cm ganme-file --from-file<span class="token operator">=</span>./mapdir/game.properties <span class="token comment">#使用字面值创建</span>kubectl create cm special-config2 --from-literal<span class="token operator">=</span>sp.how<span class="token operator">=</span>very --from-literal<span class="token operator">=</span>sp.type<span class="token operator">=</span>charm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ConfigMap-的使用"><a href="#ConfigMap-的使用" class="headerlink" title="ConfigMap 的使用"></a>ConfigMap 的使用</h2><p><strong>使用 ConfigMap 来替代环境变量</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">special.how</span><span class="token punctuation">:</span> very  <span class="token key atrule">special.type</span><span class="token punctuation">:</span> charm<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">log_level</span><span class="token punctuation">:</span> INFO<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>test<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"env"</span><span class="token punctuation">]</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_LEVEL_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.how        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_TYPE_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.type      <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>用 ConfigMap 设置命令行参数</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">special.how</span><span class="token punctuation">:</span> very  <span class="token key atrule">special.type</span><span class="token punctuation">:</span> charm<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>test<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container      <span class="token key atrule">image</span><span class="token punctuation">:</span> myapp<span class="token punctuation">:</span>v1      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)"</span><span class="token punctuation">]</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_LEVEL_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.how        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_TYPE_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.type<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>通过数据卷插件使用 ConfigMap</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">special.how</span><span class="token punctuation">:</span> very  <span class="token key atrule">special.type</span><span class="token punctuation">:</span> charm<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>test<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"cat /etc/config/special.how"</span><span class="token punctuation">]</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/config  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume      <span class="token key atrule">configMap</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>热更新</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 修改ConfigMap配置</span>$ kubectl edit configmap log<span class="token punctuation">-</span>config<span class="token comment"># 查找对应信息</span>$ kubectl exec \    `kubectl get pods <span class="token punctuation">-</span>l run=my<span class="token punctuation">-</span>nginx <span class="token punctuation">-</span>o=name<span class="token punctuation">|</span>cut <span class="token punctuation">-</span>d "/" <span class="token punctuation">-</span>f2` \    cat /etc/config/log_levelDEBUG<span class="token comment"># 修改version/config来进行滚动更新</span>kubectl patch deployment my<span class="token punctuation">-</span>nginx \    <span class="token punctuation">-</span><span class="token punctuation">-</span>patch '<span class="token punctuation">{</span><span class="token key atrule">"spec"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">"template"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">"metadata"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">"annotations"</span><span class="token punctuation">:</span> \    <span class="token punctuation">{</span><span class="token key atrule">"version/config"</span><span class="token punctuation">:</span> <span class="token string">"20190411"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h1><p>**Secret <strong>解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。</strong>Secret **可以以 Volume 或者环境变量的方式使用。Secret 有三种类型，分别是：</p><ul><li><strong>Service Account ：</strong>用来访问 Kubernetes API，由 Kubernetes 自动创建，并且会自动挂载到 Pod 的特点目录中。</li><li><strong>Opaque：</strong>base64 编码格式的 Secret，用来存储密码、密钥等，相当来说不安全。</li><li><strong>kubernetes.io/dockerconfigjson：</strong>用来存储私有 docker registry 的认证信息。</li></ul><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysecret<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">password</span><span class="token punctuation">:</span> MWYyZDFlMmU2N2Rm  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> seret<span class="token punctuation">-</span>test<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.escape.com/library/myapp<span class="token punctuation">:</span>v1      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"readOnly: true"</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets      <span class="token key atrule">secret</span><span class="token punctuation">:</span>        <span class="token key atrule">secretName</span><span class="token punctuation">:</span> mysecre  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h1><p><strong>直接挂载目录</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>ng<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 定义选择器</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment">#匹配的标签，下面定义了3个标签，将会选择有这些标签的pod</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> pvnginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> pvnginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pvnginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span><span class="token comment">#挂载pv</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ng<span class="token punctuation">-</span>data<span class="token comment">#挂载资源的名称，随便起</span>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ng/data<span class="token comment">#挂载目</span>         <span class="token comment"># 方法.直接挂载到nfs目录上</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ng<span class="token punctuation">-</span>data        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>          <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.56.12          <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfsdata/ng<span class="token punctuation">-</span>data/wordpress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h1><h2 id="一、PV（其他可参考官方文档）（静态挂载）"><a href="#一、PV（其他可参考官方文档）（静态挂载）" class="headerlink" title="一、PV（其他可参考官方文档）（静态挂载）"></a>一、PV（其他可参考官方文档）（静态挂载）</h2><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfspv <span class="token comment"># 指定存储class那么，pvc必须配置一样才行</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.56.11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="本地卷："><a href="#本地卷：" class="headerlink" title="本地卷："></a>本地卷：</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>pv<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage  <span class="token key atrule">local</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /disks  <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>    <span class="token key atrule">required</span><span class="token punctuation">:</span>      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In          <span class="token key atrule">values</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> k8s<span class="token punctuation">-</span>node1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PV 的访问模式（ accessModes） 有三种</strong>： </p><ul><li><strong>ReadWriteOnce</strong>（ RWO） ： 是最基本的方式， 可读可写， 但只支持被单个节点挂<br>载。</li><li><strong>ReadOnlyMany</strong>（ ROX） ： 可以以只读的方式被多个节点挂载。</li><li><strong>ReadWriteMany</strong>（ RWX） ： 这种存储可以以读写的方式被多个节点共享。 不是每一<br>种存储都支持这三种方式， 像共享方式， 目前支持的还比较少， 比较常用的是<br>NFS。 在 PVC 绑定 PV 时通常根据两个条件来绑定， 一个是存储的大小， 另一个就<br>是访问模式</li></ul><p><strong>PV 的回收策略（ persistentVolumeReclaimPolicy， 即 PVC 释放卷的时候 PV 该如何操<br>作） 也有三种 ：</strong></p><ul><li><strong>Retain</strong>， 不清理, 保留 Volume（ 需要手动清理） </li><li><strong>Recycle</strong>， 删除数据， 即 rm -rf /thevolume/* （ 只有 NFS 和 HostPath 支持 ）</li><li><strong>Delete</strong>， 删除存储资源， 比如删除 AWS EBS 卷（ 只有 AWS EBS, GCE PD, Azure<br>Disk 和 Cinder 支持）</li></ul><p><strong>卷阶段</strong></p><ul><li><strong>Available</strong>（可用）– 卷是一个空闲资源，尚未绑定到任何申领；</li><li><strong>Bound</strong>（已绑定）– 该卷已经绑定到某申领；</li><li><strong>Released</strong>（已释放）– 所绑定的申领已被删除，但是资源尚未被集群回收；</li><li><strong>Failed</strong>（失败）– 卷的自动回收操作失败。</li></ul><h2 id="二-PVC（PersistentVolumeClaim-）"><a href="#二-PVC（PersistentVolumeClaim-）" class="headerlink" title="二.PVC（PersistentVolumeClaim ）"></a>二.PVC（PersistentVolumeClaim ）</h2><h3 id="1-新建pvc"><a href="#1-新建pvc" class="headerlink" title="1.新建pvc"></a>1.新建pvc</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfspv <span class="token comment">#绑定与pv一直</span>  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>pop<span class="token punctuation">-</span>pv<span class="token punctuation">-</span><span class="token number">2</span> <span class="token comment"># 挂载pv名称 可选</span>  <span class="token key atrule">dataSource</span><span class="token punctuation">:</span>   <span class="token comment"># 快照卷</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> new<span class="token punctuation">-</span>snapshot<span class="token punctuation">-</span>test    <span class="token key atrule">kind</span><span class="token punctuation">:</span> VolumeSnapshot    <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> snapshot.storage.k8s.io  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce    <span class="token comment">#必须跟pv一直</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">pv</span><span class="token punctuation">:</span> kod<span class="token punctuation">-</span>pv01//定义pv标签，与pv进行关联  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-pvc挂载应用"><a href="#2-pvc挂载应用" class="headerlink" title="2.pvc挂载应用"></a>2.pvc挂载应用</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>ng<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 定义选择器</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment">#匹配的标签，下面定义了3个标签，将会选择有这些标签的pod</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> pvnginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> pvnginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pvnginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span><span class="token comment">#挂载pv</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ng<span class="token punctuation">-</span>data<span class="token comment">#挂载资源的名称，随便起</span>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ng/data<span class="token comment">#挂载目录</span>          <span class="token comment">#方法1.挂载pvc</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ng<span class="token punctuation">-</span>data<span class="token comment">#资源名称和volumemounts中的name对应</span>        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token comment">#pvc的名称</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-pv和pvc删除"><a href="#3-pv和pvc删除" class="headerlink" title="3.pv和pvc删除"></a>3.pv和pvc删除</h3><ul><li>优先删除使用deploy</li><li>在删除pvc</li><li>最后删除pv</li></ul><h2 id="三、StorageClass-动态挂载）"><a href="#三、StorageClass-动态挂载）" class="headerlink" title="三、StorageClass(动态挂载）"></a>三、StorageClass(动态挂载）</h2><p>Kubernetes提供了一套可以自动创建PV的机制,即:Dynamic Provisioning.而这个机制的核心在于:StorageClass这个API对象. </p><h3 id="1-步骤"><a href="#1-步骤" class="headerlink" title="1.步骤"></a>1.步骤</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">1.</span>创建一个可用的<span class="token constant">NFS</span> <span class="token class-name">Serve</span><span class="token number">2.</span>创建<span class="token class-name">Service</span> <span class="token class-name">Account</span><span class="token punctuation">.</span>这是用来管控<span class="token constant">NFS</span> provisioner在k8s集群中运行的权限<span class="token number">3.</span>创建<span class="token class-name">StorageClass</span><span class="token punctuation">.</span>负责建立<span class="token constant">PVC</span>并调用<span class="token constant">NFS</span> provisioner进行预定的工作<span class="token punctuation">,</span>并让<span class="token constant">PV</span>与<span class="token constant">PVC</span>建立管理<span class="token number">4.</span>创建<span class="token constant">NFS</span> provisioner<span class="token punctuation">.</span>有两个功能<span class="token punctuation">,</span>一个是在<span class="token constant">NFS</span>共享目录下创建挂载点<span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span>另一个则是建了<span class="token constant">PV</span>并将<span class="token constant">PV</span>与<span class="token constant">NFS</span>的挂载点建立关联  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-搭建"><a href="#2-搭建" class="headerlink" title="2.搭建"></a>2.搭建</h3><h4 id="2-1创建rbac配置account和权限"><a href="#2-1创建rbac配置account和权限" class="headerlink" title="2.1创建rbac配置account和权限"></a>2.1创建rbac配置account和权限</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token comment"># replace with namespace where provisioner is deployed</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default        <span class="token comment">#根据实际环境设定namespace,下面类同</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token comment"># replace with namespace where provisioner is deployed</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token comment"># replace with namespace where provisioner is deployed</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token comment"># replace with namespace where provisioner is deployed</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2创建NFS资源的StorageClass"><a href="#2-2创建NFS资源的StorageClass" class="headerlink" title="2.2创建NFS资源的StorageClass"></a>2.2创建NFS资源的StorageClass</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> qgg<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage <span class="token comment">#这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span><span class="token key atrule">parameters</span><span class="token punctuation">:</span>  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-3创建nfs-Provisioner"><a href="#2-3创建nfs-Provisioner" class="headerlink" title="2.3创建nfs-Provisioner"></a>2.3创建nfs-Provisioner</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token comment"># replace with namespace where provisioner is deployed</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token comment">#与RBAC文件中的namespace保持一致</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/external_storage/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> qgg<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage  <span class="token comment">#provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.56.11   <span class="token comment">#NFS Server IP地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH                <span class="token key atrule">value</span><span class="token punctuation">:</span> /nfsdata    <span class="token comment">#NFS挂载卷</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.56.11  <span class="token comment">#NFS Server IP地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfsdata     <span class="token comment">#NFS 挂载卷</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-4创建pvc"><a href="#2-4创建pvc" class="headerlink" title="2.4创建pvc"></a>2.4创建pvc</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>claim  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">volume.beta.kubernetes.io/storage-class</span><span class="token punctuation">:</span> <span class="token string">"managed-nfs-storage"</span>   <span class="token comment">#与nfs-StorageClass.yaml metadata.name保持一致</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-5设置默认sc"><a href="#2-5设置默认sc" class="headerlink" title="2.5设置默认sc"></a>2.5设置默认sc</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl patch storageclass managed-nfs-storage <span class="token parameter variable">-p</span> <span class="token string">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-6出现创建pvc后一直等待情况waiting-for-a-volume-to-be-created-either-by-external-provisioner-“qgg-nfs-storage”-or-manually-created-by-system-administrator"><a href="#2-6出现创建pvc后一直等待情况waiting-for-a-volume-to-be-created-either-by-external-provisioner-“qgg-nfs-storage”-or-manually-created-by-system-administrator" class="headerlink" title="2.6出现创建pvc后一直等待情况waiting for a volume to be created, either by external provisioner “qgg-nfs-storage” or manually created by system administrator"></a>2.6出现创建pvc后一直等待情况<a href="https://www.cnblogs.com/Applogize/p/15161379.html">waiting for a volume to be created, either by external provisioner “qgg-nfs-storage” or manually created by system administrator</a></h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 修改kube-apiserver.yaml文件</span>参考地址：https<span class="token punctuation">:</span>//www.cnblogs.com/Applogize/p/15161379.html<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser01 nfs.rbac<span class="token punctuation">]</span><span class="token comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/apiserver.key    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>feature<span class="token punctuation">-</span>gates=RemoveSelfLink=false <span class="token comment"># 添加这个配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、案例-搭建redis服务器并挂载）"><a href="#四、案例-搭建redis服务器并挂载）" class="headerlink" title="四、案例(搭建redis服务器并挂载）"></a>四、案例(搭建redis服务器并挂载）</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pvc  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">volume.beta.kubernetes.io/storage-class</span><span class="token punctuation">:</span> <span class="token string">"managed-nfs-storage"</span>   <span class="token comment">#与nfs-StorageClass.yaml metadata.name保持一致</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Mi<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>redis   <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>devops<span class="token punctuation">-</span>redis<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>   <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>redis  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>redis    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>container          <span class="token key atrule">image</span><span class="token punctuation">:</span> redis          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/data/redis-data/"</span> <span class="token comment"># 挂载容器里面的目录</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>datadir      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>datadir          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pvc  <span class="token comment"># 挂载k8s的pvc名称</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>redis  <span class="token key atrule">name</span><span class="token punctuation">:</span> srv<span class="token punctuation">-</span>devops<span class="token punctuation">-</span>redis<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>     <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>redis  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP  <span class="token key atrule">sessionAffinityConfig</span><span class="token punctuation">:</span>    <span class="token key atrule">clientIP</span><span class="token punctuation">:</span>      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10800</span>      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>article title</title>
      <link href="/article-title.html"/>
      <url>/article-title.html</url>
      
        <content type="html"><![CDATA[<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/hello-world.html"/>
      <url>/hello-world.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
